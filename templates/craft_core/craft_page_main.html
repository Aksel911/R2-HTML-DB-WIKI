<!-- Использует только общие main_css, все остальное свое -->
<!DOCTYPE html>
<html>
<head>
    <title>{% block title %}{% endblock %}</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Didact+Gothic&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <link rel="stylesheet" href="/static/bg/css/main_css.css">
</head>
<body>
    <h1>{% block header %}{% endblock %}</h1>

    {% include 'main_page_menu.html' %}

    <button class="theme-toggle" id="theme-toggle">
        <i class="fas fa-adjust"></i>
    </button>

    {% block content %}
    <div class="craft-container">
        <div class="craft-window">
            <!-- Заголовок окна -->
            <div class="craft-header">
                <div class="header-text">
                    <i class="fas fa-hammer"></i>
                    <span>Создание предмета</span>
                </div>
                <div class="header-buttons">
                    <div class="search-container">
                        <div class="search-wrapper">
                            <input type="text" class="search-input" placeholder="Поиск предмета...">
                            <button class="search-btn">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Основное содержимое -->
            <div class="craft-content">
                <!-- Левая панель с деталями крафта -->
                <div class="craft-details">
                    <div id="craft-details-container">
                        <div class="initial-message">
                            <i class="fas fa-info-circle"></i>
                            Выберите предмет для крафта из списка справа
                        </div>
                    </div>
                </div>

                <!-- Правая панель с меню -->
                <div class="items-menu">
                    {% for group1 in group1_names.keys()|sort %}
                    <div class="menu-group">
                        <div class="menu-header" onclick="toggleGroup(this)" data-group="{{ group1 }}">
                            <i class="fas fa-plus"></i>
                            {{ group1_names[group1] }}
                        </div>
                        <div class="submenu" style="display: none;" id="group-{{ group1 }}-items">
                            <div class="group-loading">
                                <i class="fas fa-spinner fa-spin"></i> Загрузка...
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Уведомления -->
    <div class="notification-overlay" style="display: none;">
        <div class="notification-message">
            <i class="notification-icon"></i>
            <span class="notification-text"></span>
        </div>
    </div>

    <!-- Индикатор загрузки -->
    <div id="loading-indicator" style="display: none;">
        <div class="spinner">
            <i class="fas fa-spinner fa-spin"></i>
        </div>
    </div>

<style>
/* Основные переменные */
:root {
    --bg-primary: #ffffff;
    --bg-secondary: #f8f9fa;
    --bg-tertiary: #f1f3f5;
    --border-color: #dee2e6;
    --text-primary: #212529;
    --text-secondary: #6c757d;
    --accent-color: #0d6efd;
    --success-color: #198754;
    --error-color: #dc3545;
    --gold-color: #ffd700;
    --silver-color: #adb5bd;
    --item-border: #444;
    --item-bg: #f8f9fa;
    --hover-bg: #f1f3f5;
}

.dark-theme {
    --bg-primary: #1a1a1a;
    --bg-secondary: #2d2d2d;
    --bg-tertiary: #333333;
    --border-color: #404040;
    --text-primary: #ffffff;
    --text-secondary: #d4d4d4;
    --accent-color: #ffd700;
    --success-color: rgba(0, 255, 0, 0.7);
    --error-color: #ff4444;
    --gold-color: #ffd700;
    --silver-color: #c0c0c0;
    --item-border: #666;
    --item-bg: #2d2d2d;
    --hover-bg: #404040;
}

/* Основные стили контейнера */
.craft-container {
    display: flex;
    justify-content: center;
    padding: 20px;
    min-height: calc(100vh - 60px);
}

.craft-window {
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    width: 900px;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
    overflow: hidden;
}

/* Стили заголовка */
.craft-header {
    background: var(--bg-secondary);
    padding: 12px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border-color);
}

.header-text {
    color: var(--text-primary);
    font-size: 26px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 8px;
}

/* Стили поиска */
.search-container {
    position: relative;
}

.search-wrapper {
    display: flex;
    align-items: center;
    gap: 8px;
}

.search-input {
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: 8px 12px;
    background: var(--bg-primary);
    color: var(--text-primary);
    width: 200px;
    outline: none;
    transition: all 0.3s ease;
}

.search-input:focus {
    border-color: var(--accent-color);
    box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.25);
}

.search-btn {
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
    padding: 8px 12px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
}

.search-btn:hover {
    background: var(--hover-bg);
    color: var(--text-primary);
}

/* Основной контент */
.craft-content {
    display: flex;
    height: 725px;
}

.craft-details {
    flex: 1;
    padding: 20px;
    border-right: 1px solid var(--border-color);
    position: relative;
    overflow-y: auto;
}

.items-menu {
    width: 300px;
    background: var(--bg-secondary);
    overflow-y: auto;
}

/* Стили меню */
.menu-group {
    margin-bottom: 2px;
}

.menu-header,
.submenu-header {
    padding: 8px 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    border-radius: 4px;
    color: var(--text-primary);
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    transition: all 0.2s ease;
}

.menu-header:hover,
.submenu-header:hover {
    background: var(--hover-bg);
}

.menu-header i,
.submenu-header i {
    color: var(--text-secondary);
    width: 16px;
    text-align: center;
    transition: transform 0.3s ease;
}

.submenu {
    margin-left: 15px;
    display: none;
}

/* Стили элементов списка */
.craft-list-item {
    padding: 8px 12px 8px 36px;
    cursor: pointer;
    color: var(--text-secondary);
    position: relative;
    border-radius: 4px;
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    margin-bottom: 1px;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
}

.craft-list-item:hover {
    background: var(--hover-bg);
    color: var(--text-primary);
    transform: translateX(5px);
}

.craft-list-item img {
    margin-right: 8px;
    transition: transform 0.3s ease;
    width: 24px;
    height: 24px;
    object-fit: contain;
}

.craft-list-item:hover img {
    transform: scale(1.2);
}

.craft-list-item.selected {
    color: var(--accent-color);
    background: var(--bg-secondary);
    border-color: var(--accent-color);
}

.craft-list-item.selected img {
    filter: brightness(1.2);
}

/* Стили деталей крафта */
.craft-main {
    margin-left: 15px;
}

.item-title {
    margin-bottom: 20px;
    font-size: 18px;
    color: var(--accent-color);
}

.item-preview {
    position: relative;
    width: 64px;
    height: 64px;
}

.item-frame {
    width: 100%;
    height: 100%;
    border: 2px solid var(--item-border);
    border-radius: 4px;
    background: var(--item-bg);
    padding: 2px;
    position: relative;
}

.item-icon {
    width: 100%;
    height: 100%;
    object-fit: contain;
}

.create-count {
    position: absolute;
    bottom: -2px;
    right: -2px;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 12px;
    border: 1px solid var(--item-border);
}

/* Стили контейнера материалов */
.materials-container {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 16px;
    margin-top: 20px;
    margin-bottom: 70px;
}

.materials-header {
    color: var(--text-primary);
    font-size: 16px;
    font-weight: 500;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.material-slot {
    display: flex;
    align-items: center;
    padding: 12px;
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    margin-bottom: 8px;
    transition: all 0.2s ease;
}

.material-slot:hover {
    border-color: var(--accent-color);
    transform: translateX(5px);
}

.material-slot.empty {
    height: 60px;
    background: var(--bg-secondary);
    display: flex;
    justify-content: center;
    align-items: center;
}

.material-frame {
    width: 40px;
    height: 40px;
    border: 2px solid var(--item-border);
    border-radius: 4px;
    background: var(--item-bg);
    margin-right: 12px;
    padding: 2px;
}

.material-frame img {
    width: 100%;
    height: 100%;
    object-fit: contain;
}

/* Текстовые стили */
.gold-text {
    color: var(--gold-color);
    margin-bottom: 4px;
}

.silver-text {
    color: var(--silver-color);
    margin-bottom: 4px;
}

.success-text {
    color: var(--success-color);
}

.failure-text {
    color: var(--error-color);
}

/* Кнопки крафта */
.craft-buttons {
    position: absolute;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--bg-primary);
    padding: 16px;
    display: flex;
    justify-content: space-between;
    gap: 16px;
    border-top: 1px solid var(--border-color);
}

.create-btn,
.close-btn {
    flex: 1;
    padding: 12px 24px;
    border: none;
    border-radius: 6px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.create-btn {
    background: var(--success-color);
    color: white;
}

.close-btn {
    background: var(--error-color);
    color: white;
}

.create-btn:hover,
.close-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

/* Уведомления */
.notification-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

.notification-message {
    background: var(--bg-primary);
    padding: 20px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    gap: 12px;
    transform: translateY(20px);
    transition: all 0.3s ease;
    min-width: 300px;
}

.notification-message .notification-content {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.notification-message .item-result {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
    padding: 8px;
    background: var(--bg-secondary);
    border-radius: 4px;
}

.notification-message .item-result img {
    width: 32px;
    height: 32px;
    object-fit: contain;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: 2px;
    background: var(--item-bg);
}

.notification-overlay.show {
    opacity: 1;
    visibility: visible;
}

.notification-overlay.show .notification-message {
    transform: translateY(0);
}

.notification-overlay.success .notification-message {
    border: 1px solid var(--success-color);
}

.notification-overlay.error .notification-message {
    border: 1px solid var(--error-color);
}

/* Загрузчик */
#loading-indicator {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.8);
    padding: 1rem;
    border-radius: 0.5rem;
    color: white;
    z-index: 1000;
}

.spinner {
    font-size: 2rem;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Конфетти */
.confetti {
    width: 10px;
    height: 10px;
    position: fixed;
    pointer-events: none;
    z-index: 9999;
    animation: confettiFall 6s linear infinite;
}

.confetti.square {
    width: 8px;
    height: 8px;
}

.confetti.circle {
    border-radius: 50%;
}

@keyframes confettiFall {
    0% {
        transform: translateY(-100vh) rotate(0deg);
    }
    100% {
        transform: translateY(100vh) rotate(720deg);
    }
}

@keyframes itemGlow {
    0% {
        box-shadow: 0 0 5px var(--accent-color);
    }
    50% {
        box-shadow: 0 0 20px var(--accent-color);
    }
    100% {
        box-shadow: 0 0 5px var(--accent-color);
    }
}

/* Анимация встряхивания при неудаче */
@keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
    20%, 40%, 60%, 80% { transform: translateX(5px); }
}

.shake {
    animation: shake 0.5s ease-in-out;
}

/* Адаптивная верстка */
@media (max-width: 768px) {
    .craft-container {
        padding: 10px;
    }

    .craft-window {
        width: 100%;
    }

    .craft-content {
        flex-direction: column;
        height: auto;
    }

    .items-menu {
        width: 100%;
        max-height: 300px;
        order: -1;
    }

    .craft-details {
        border-right: none;
        border-top: 1px solid var(--border-color);
        margin-top: 20px;
    }

    .craft-buttons {
        position: static;
        margin-top: 20px;
    }

    .search-input {
        width: 150px;
    }
}

/* Темная тема для уведомлений */
.dark-theme .notification-message {
    background: var(--bg-primary);
    color: var(--text-primary);
}
</style>

<script>
// Глобальные переменные
let loadedGroups = new Set();
let loadedCrafts = new Set();
let currentPage = {};
const itemsPerPage = 20;
let isLoading = false;
let availableMoney = 10000000;
let searchTimeout = null;

// Данные из сервера
const group2_names = {
{% for key, value in group2_names.items() %}
    '{{ key }}': '{{ value }}',
{% endfor %}
};

// Элементы поиска
const searchBtn = document.querySelector('.search-btn');
const searchInput = document.querySelector('.search-input');
const allCrafts = {{ all_crafts|tojson|safe }};




// Функции загрузки
function toggleLoading(show) {
    const indicator = document.getElementById('loading-indicator');
    indicator.style.display = show ? 'block' : 'none';
    isLoading = show;
}

async function loadGroupItems(groupId, group2 = null) {
    if (isLoading) return;
    
    const container = document.getElementById(`group-${groupId}${group2 ? '-' + group2 : ''}-items`);
    if (!container) return;
    
    try {
        toggleLoading(true);
        
        const url = group2 
            ? `/api/craft_group/${groupId}?group2=${group2}`
            : `/api/craft_group/${groupId}`;
            
        const response = await fetch(url);
        const data = await response.json();
        
        if (!group2) {
            // Проверяем, есть ли подгруппы
            const hasSubgroups = data.items.length > 0 && data.items[0].hasOwnProperty('group2');
            
            if (hasSubgroups) {
                // Загружаем структуру подгрупп
                const subgroupsHtml = data.items
                    .map(item => {
                        // Формируем ключ для group2_names
                        const subgroupKey = `${groupId}${item.group2}`;
                        const subgroupName = group2_names[subgroupKey];
                        
                        if (!subgroupName) return '';
                        
                        return `
                            <div class="submenu-category">
                                <div class="submenu-header" onclick="toggleSubGroup(this)" data-group="${groupId}" data-subgroup="${item.group2}">
                                    <i class="fas fa-plus"></i>
                                    ${subgroupName}
                                </div>
                                <div class="submenu-items" style="display: none;" id="group-${groupId}-${item.group2}-items">
                                    <div class="group-loading">
                                        <i class="fas fa-spinner fa-spin"></i> Загрузка...
                                    </div>
                                </div>
                            </div>
                        `;
                    })
                    .filter(Boolean)
                    .join('');
                
                if (subgroupsHtml) {
                    container.innerHTML = subgroupsHtml;
                } else {
                    // Если нет подходящих подгрупп, загружаем все предметы
                    loadGroupItems(groupId, '0');
                }
            } else {
                // Если нет подгрупп, отображаем предметы
                container.innerHTML = generateItemsList(data.items);
            }
        } else {
            // Загружаем предметы конкретной подгруппы
            container.innerHTML = generateItemsList(data.items);
        }
        
        loadedGroups.add(group2 ? `${groupId}-${group2}` : groupId);
    } catch (error) {
        console.error('Error loading group items:', error);
        container.innerHTML = '<div class="error-message">Ошибка загрузки</div>';
    } finally {
        toggleLoading(false);
    }
}

function generateItemsList(items) {
    if (!Array.isArray(items) || items.length === 0) {
        return '<div class="empty-message">Нет предметов</div>';
    }
    
    return items
        .filter(item => item.result_name) // Проверяем наличие result_name
        .map(item => `
            <div class="craft-list-item" 
                 onclick="showCraftDetails('${item.rid}')"
                 data-search-text="${item.result_name.toLowerCase()}"
                 data-rid="${item.rid}">
                <img src="${item.result_pic}" 
                     alt="${item.result_name}" 
                     width="24" height="24" 
                     loading="lazy"
                     onerror="this.onerror=null; this.src='/static/no_item_image.png';">
                ${item.result_name}${item.create_count > 1 ? ` (${item.create_count})` : ''}
            </div>
        `)
        .join('');
}


function toggleSubGroup(element) {
    const groupId = element.dataset.group;
    const subgroup = element.dataset.subgroup;
    const container = document.getElementById(`group-${groupId}-${subgroup}-items`);
    const icon = element.querySelector('i');
    
    if (container.style.display === 'none') {
        container.style.display = 'block';
        icon.classList.remove('fa-plus');
        icon.classList.add('fa-minus');
        
        if (!loadedGroups.has(`${groupId}-${subgroup}`)) {
            loadGroupItems(groupId, subgroup);
        }
    } else {
        container.style.display = 'none';
        icon.classList.remove('fa-minus');
        icon.classList.add('fa-plus');
    }
}


// Обработчик прокрутки
function handleScroll(groupId, container) {
    if (isLoading) return;
    
    const scrollPosition = container.scrollTop + container.clientHeight;
    const scrollHeight = container.scrollHeight;
    
    if (scrollHeight - scrollPosition <= 100) {
        loadGroupItems(groupId, (currentPage[groupId] || 1) + 1);
    }
}

// Функции крафта
async function showCraftDetails(craftId) {
    if (isLoading) return;
    
    // Подсветка выбранного предмета
    document.querySelectorAll('.craft-list-item').forEach(item => {
        item.classList.remove('selected');
    });
    document.querySelector(`[data-rid="${craftId}"]`)?.classList.add('selected');
    
    if (loadedCrafts.has(craftId)) {
        document.querySelectorAll('.craft-info').forEach(el => el.style.display = 'none');
        document.getElementById(`craft-${craftId}`).style.display = 'block';
        return;
    }
    
    try {
        toggleLoading(true);
        
        const response = await fetch(`/api/craft_details/${craftId}`);
        const craftData = await response.json();
        
        const container = document.getElementById('craft-details-container');
        const craftHtml = generateCraftHtml(craftData);
        
        document.querySelector('.initial-message')?.remove();
        
        if (!loadedCrafts.size) {
            container.innerHTML = craftHtml;
        } else {
            container.insertAdjacentHTML('beforeend', craftHtml);
        }
        
        loadedCrafts.add(craftId);
        
        // Показываем текущий крафт
        document.querySelectorAll('.craft-info').forEach(el => el.style.display = 'none');
        document.getElementById(`craft-${craftId}`).style.display = 'block';
        
    } catch (error) {
        console.error('Error loading craft details:', error);
        showNotification('Ошибка загрузки данных крафта', 'error');
    } finally {
        toggleLoading(false);
    }
}


// Функция показа уведомлений
function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `notification-overlay ${type}`;
    
    const content = `
        <div class="notification-message">
            <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-times-circle'}"></i>
            <div class="notification-content">
                <div>${message}</div>
            </div>
        </div>
    `;
    
    notification.innerHTML = content;
    document.body.appendChild(notification);
    
    // Показываем уведомление
    setTimeout(() => {
        notification.classList.add('show');
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => notification.remove(), 300);
        }, 2000);
    }, 100);
}

// Генерация HTML для крафта
function generateCraftHtml(craftData) {
    return `
        <div class="craft-info" id="craft-${craftData.rid}">
            <div class="item-title">
                <a href="/item/${craftData.result_item_id}" class="item-link">
                    <i class="fas fa-link"></i>
                    ${craftData.result_name}
                </a>
            </div>
            <div class="craft-main">
                <div class="result-item">
                    <div class="item-preview">
                        <a href="/item/${craftData.result_item_id}">
                            <div class="item-frame">
                                <img src="${craftData.result_pic}" 
                                     alt="${craftData.result_name}" 
                                     class="item-icon"
                                     loading="lazy"
                                     onerror="this.onerror=null; this.src='/static/no_item_image.png';">
                                ${craftData.create_count > 1 ? 
                                    `<div class="create-count">${craftData.create_count}</div>` : ''}
                            </div>
                        </a>
                    </div>
                </div>
                <div class="craft-info-text">
                    <div class="gold-text">
                        <i class="fas fa-coins"></i>
                        Изготовленное серебро: ${craftData.cost}
                    </div>
                    <div class="silver-text">
                        <i class="fas fa-wallet"></i>
                        В наличии: ${availableMoney.toLocaleString()}
                    </div>
                    ${craftData.success_rate === 100 ?
                        `<div class="success-text">
                            <i class="fas fa-check-circle"></i>
                            Изготовление предмета успешно на 100%
                        </div>` :
                        `<div class="failure-text">
                            <i class="fas fa-exclamation-triangle"></i>
                            [${craftData.success_rate}%] Возможна неудача во время создания предмета.
                        </div>`
                    }
                </div>
            </div>
            
            <div class="materials-container">
                <div class="materials-header">
                    <i class="fas fa-cube"></i>
                    Необходимые материалы
                </div>
                ${craftData.materials.map(material => `
                    <div class="material-slot">
                        <a href="/item/${material.item_id}" class="material-preview">
                            <div class="material-frame">
                                <img src="${material.pic}" 
                                     alt="${material.name}"
                                     loading="lazy"
                                     onerror="this.onerror=null; this.src='/static/no_item_image.png';">
                            </div>
                        </a>
                        <div class="material-info">
                            <a href="/item/${material.item_id}" class="material-name">${material.name}</a>
                            <div class="material-quantity">${material.count} / ${material.count} / (0)</div>
                        </div>
                    </div>
                `).join('')}
                ${Array(4 - craftData.materials.length).fill().map(() => `
                    <div class="material-slot empty">
                        <div class="empty-slot-icon">
                            <i class="fas fa-slash"></i>
                        </div>
                    </div>
                `).join('')}
            </div>
            
            <div class="craft-buttons">
                <button class="create-btn" onclick="craftItem(event)">
                    <i class="fas fa-hammer"></i>
                    Создание
                </button>
                <button class="close-btn" onclick="closeCraftWindow(event)">
                    <i class="fas fa-times"></i>
                    Закрыть
                </button>
            </div>
        </div>
    `;
}

// Функция крафта предмета
function craftItem(event) {
    if (isLoading) return;
    
    const button = event.target.closest('.create-btn');
    if (!button) return;
    
    const craftInfo = button.closest('.craft-info');
    const costElement = craftInfo.querySelector('.gold-text');
    const cost = parseInt(costElement.textContent.match(/\d+/)[0]);
    
    // Проверка наличия денег
    if (availableMoney < cost) {
        showNotification('Недостаточно денег для создания предмета!', 'error');
        return;
    }
    
    const successRateText = craftInfo.querySelector('.failure-text')?.textContent || 
                         craftInfo.querySelector('.success-text')?.textContent;
    const successRateMatch = successRateText.match(/\[(\d+)%\]/);
    
    let success = true;
    if (successRateMatch) {
        const successRate = parseInt(successRateMatch[1]);
        success = (Math.random() * 100) <= successRate;
    }
    
    // Анимация нажатия кнопки
    button.style.transform = 'scale(0.95)';
    setTimeout(() => button.style.transform = '', 100);
    
    // Списываем деньги в любом случае
    availableMoney -= cost;
    updateAvailableMoney();
    
    // Данные предмета для уведомления
    const craftData = {
        result_pic: craftInfo.querySelector('.item-icon').src,
        result_name: craftInfo.querySelector('.item-title').textContent.trim()
    };
    
    if (success) {
        showCraftNotification(craftData, true);
        
        // Анимация успешного создания
        const itemPreview = craftInfo.querySelector('.item-frame');
        itemPreview.style.animation = 'itemGlow 1s ease';
        setTimeout(() => itemPreview.style.animation = '', 1000);
        
        createConfetti('success');
        playSound('success');
    } else {
        showCraftNotification(null, false);
        
        // Анимация неудачи
        craftInfo.classList.add('shake');
        setTimeout(() => craftInfo.classList.remove('shake'), 500);
        
        createConfetti('error');
        playSound('error');
    }
}

// Функция показа уведомления о крафте
function showCraftNotification(craftData, success) {
    const notification = document.createElement('div');
    notification.className = `notification-overlay ${success ? 'success' : 'error'}`;
    
    const content = success ? `
        <div class="notification-message">
            <i class="fas fa-check-circle"></i>
            <div class="notification-content">
                <div>Предмет успешно создан!</div>
                <div class="item-result">
                    <img src="${craftData.result_pic}" alt="${craftData.result_name}">
                    <span>Вы получили: ${craftData.result_name}</span>
                </div>
            </div>
        </div>
    ` : `
        <div class="notification-message">
            <i class="fas fa-times-circle"></i>
            <span>Не удалось создать предмет...</span>
        </div>
    `;
    
    notification.innerHTML = content;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.classList.add('show');
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => notification.remove(), 300);
        }, 2000);
    }, 100);
}

// Обновление отображения денег
function updateAvailableMoney() {
    document.querySelectorAll('.silver-text').forEach(text => {
        text.innerHTML = `
            <i class="fas fa-wallet"></i>
            В наличии: ${availableMoney.toLocaleString()}
        `;
    });
}

// Воспроизведение звуков
function playSound(type) {
    const sounds = {
        success: 'https://github.com/Aksel911/R2-Textures/raw/refs/heads/main/%5BFIX%5D%20FIXES/%5BFIX%5D%20%D0%A1%D1%82%D0%B0%D1%80%D1%8B%D0%B9%20%D1%8D%D1%84%D1%84%D0%B5%D0%BA%D1%82%20%D0%B7%D0%B0%D1%82%D0%BE%D1%87%D0%BA%D0%B8/sound/10th_success.wav',
        error: 'https://github.com/Aksel911/R2-Textures/raw/refs/heads/main/%5BFIX%5D%20FIXES/%5BFIX%5D%20%D0%A1%D1%82%D0%B0%D1%80%D1%8B%D0%B9%20%D1%8D%D1%84%D1%84%D0%B5%D0%BA%D1%82%20%D0%B7%D0%B0%D1%82%D0%BE%D1%87%D0%BA%D0%B8/sound/FAIL_02.wav',
        theme: 'https://github.com/Aksel911/R2-Textures/raw/refs/heads/main/%5BFIX%5D%20FIXES/%5BFIX%5D%20%D0%A1%D1%82%D0%B0%D1%80%D1%8B%D0%B9%20%D1%8D%D1%84%D1%84%D0%B5%D0%BA%D1%82%20%D0%B7%D0%B0%D1%82%D0%BE%D1%87%D0%BA%D0%B8/sound/gui_click.wav'
    };
    
    const audio = new Audio(sounds[type]);
    audio.play().catch(error => console.log('Error playing sound:', error));
}

// Эффекты конфетти
function createConfetti(type) {
    const colors = type === 'success' 
        ? ['#ff6b6b', '#f06595', '#cc5de8', '#845ef7', '#5c7cfa', '#339af0', '#22b8cf', '#20c997', '#51cf66', '#94d82d', '#fcc419']
        : ['#ff0000', '#ff4444', '#ff8888'];
        
    const container = document.createElement('div');
    container.style.position = 'fixed';
    container.style.top = '0';
    container.style.left = '0';
    container.style.width = '100%';
    container.style.height = '100%';
    container.style.pointerEvents = 'none';
    container.style.zIndex = '9999';
    document.body.appendChild(container);
    
    for (let i = 0; i < 150; i++) {
        const confetti = document.createElement('div');
        confetti.className = `confetti ${['square', 'circle'][Math.floor(Math.random() * 2)]}`;
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.left = `${Math.random() * 100}vw`;
        confetti.style.animationDuration = `${Math.random() * 2 + 2}s`;
        confetti.style.opacity = Math.random() * 0.4 + 0.6;
        container.appendChild(confetti);
    }
    
    setTimeout(() => {
        container.style.transition = 'opacity 1s ease-out';
        container.style.opacity = '0';
        setTimeout(() => container.remove(), 1000);
    }, 2000);
}

// Функции поиска
searchBtn.addEventListener('click', () => {
    if (searchInput.style.display === 'none') {
        searchInput.style.display = 'block';
        searchInput.focus();
        searchBtn.innerHTML = '<i class="fas fa-times"></i>';
    } else {
        searchInput.style.display = 'none';
        searchInput.value = '';
        searchBtn.innerHTML = '<i class="fas fa-search"></i>';
        performSearch('');
    }
});

searchInput.addEventListener('input', (e) => {
    if (searchTimeout) {
        clearTimeout(searchTimeout);
    }
    searchTimeout = setTimeout(() => performSearch(e.target.value), 300);
});


async function loadAllGroups() {
    for (const group of document.querySelectorAll('.menu-group')) {
        const groupId = group.querySelector('.menu-header').dataset.group;
        await loadGroupItems(groupId);

        for (const subgroup of group.querySelectorAll('.submenu-header')) {
            const subgroupId = subgroup.dataset.subgroup;
            await loadGroupItems(groupId, subgroupId);
        }
    }
}


function performSearch(query) {
    const searchText = query.toLowerCase();
    let found = false;

    document.querySelectorAll('.menu-group').forEach(group => {
        const groupId = group.querySelector('.menu-header').dataset.group;
        const submenu = group.querySelector('.submenu');
        let hasVisibleItems = false;

        // Получаем все предметы для этой группы из allCrafts
        const groupData = allCrafts[groupId];
        if (groupData) {
            // Перебираем все подгруппы
            Object.keys(groupData).forEach(subgroupId => {
                const items = groupData[subgroupId];
                const hasMatchingItems = items.some(item => item.result_name.toLowerCase().includes(searchText));

                if (hasMatchingItems) {
                    hasVisibleItems = true;
                    found = true;
                }

                // Показываем или скрываем подгруппу
                const subgroupContainer = submenu.querySelector(`#group-${groupId}-${subgroupId}-items`);
                if (subgroupContainer) {
                    subgroupContainer.style.display = hasMatchingItems ? 'block' : 'none';
                }
            });
        }

        // Управляем отображением группы
        submenu.style.display = hasVisibleItems ? 'block' : 'none';
        group.style.display = hasVisibleItems ? 'block' : 'none';
        const groupIcon = group.querySelector('.menu-header i');
        groupIcon.className = hasVisibleItems ? 'fas fa-minus' : 'fas fa-plus';
    });

    if (searchText && !found) {
        showNotification('Ничего не найдено', 'error');
    }
}

// Переключение групп
function toggleGroup(element) {
    const groupId = element.dataset.group;
    const submenu = document.getElementById(`group-${groupId}-items`);
    const icon = element.querySelector('i');
    
    if (submenu.style.display === 'none') {
        submenu.style.display = 'block';
        icon.classList.remove('fa-plus');
        icon.classList.add('fa-minus');
        
        if (!loadedGroups.has(groupId)) {
            loadGroupItems(groupId);
        }
    } else {
        submenu.style.display = 'none';
        icon.classList.remove('fa-minus');
        icon.classList.add('fa-plus');
    }
}

// Закрытие окна крафта
function closeCraftWindow(event) {
    const craftInfo = event.target.closest('.craft-info');
    if (craftInfo) {
        craftInfo.style.display = 'none';
        document.querySelector('.initial-message').style.display = 'block';
    }
}

// Переключение темы
function toggleTheme() {
    document.body.classList.toggle('dark-theme');
    localStorage.setItem('theme', document.body.classList.contains('dark-theme') ? 'dark' : 'light');
    playSound('theme');
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', () => {
    // Загружаем первую группу по умолчанию
    //const firstGroup = document.querySelector('.menu-header');
    //if (firstGroup) {
    //    toggleGroup(firstGroup);
    //}
    // Грузим все блоки
    loadAllGroups();
    
    // Обработчик темы
    const themeToggle = document.getElementById('theme-toggle');
    if (themeToggle) {
        themeToggle.addEventListener('click', toggleTheme);
    }
    
    // Применяем сохраненную тему
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
        document.body.classList.add('dark-theme');
    }
    
    // Обработка Escape для поиска
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && searchInput.style.display !== 'none') {
            searchBtn.click();
        }
    });
});
</script>

{% endblock %}

<!-- Scripts -->
{% block scripts %}
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.25/js/dataTables.bootstrap4.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
{% endblock %}

</body>
</html>
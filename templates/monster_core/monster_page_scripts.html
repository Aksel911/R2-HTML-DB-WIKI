
<!-- Image Handling Script -->
<script>
    function initializeImageZoom() {
        $('.monster-image').each(function() {
            var $img = $(this);
            $img.off('mouseenter mouseleave');

            $img.hover(
                function() {
                    $(this).css({
                        'transform': 'scale(2)',
                        'z-index': '1000',
                        'transition': 'transform 0.3s ease'
                    });
                },
                function() {
                    $(this).css({
                        'transform': 'scale(1)',
                        'z-index': '1',
                        'transition': 'transform 0.3s ease'
                    });
                }
            );
        });
    }
</script>

<!-- Search Functionality Script -->
<script>
    $(document).ready(function() {
        var searchTimeout;

        $('#search-input').on('input', function() {
            var $input = $(this);
            var searchText = $input.val().trim();

            clearTimeout(searchTimeout);
            $('.loading-spinner').fadeIn();

            searchTimeout = setTimeout(function() {
                window.table.search(searchText).draw();
                updateSearchSuggestions(searchText);
                $('.loading-spinner').fadeOut();
            }, 300);
        });

        function updateSearchSuggestions(searchText) {
            var $results = $('#search-results');
            $results.empty();

            if (searchText.length < 2) {
                $results.hide();
                return;
            }

            var matches = window.monsterCache
                .filter(function(monster) {
                    return monster.name.toLowerCase().includes(searchText.toLowerCase());
                })
                .slice(0, 5);

            if (matches.length > 0) {
                matches.forEach(function(match) {
                    var $link = $('<a>')
                        .addClass('dropdown-item')
                        .attr('href', '/monster/' + match.id)
                        .text(match.name)
                        .click(function(e) {
                            e.preventDefault();
                            $('#search-input').val(match.name);
                            window.table.search(match.name).draw();
                            $results.hide();
                        });
                    $results.append($link);
                });
                $results.show();
            } else {
                $results.hide();
            }
        }

        $(document).click(function(e) {
            if (!$(e.target).closest('.search-container').length) {
                $('#search-results').hide();
            }
        });
    });
</script>

<!-- Data Caching Script -->
<script>
    function cacheMonsterData() {
        window.monsterCache = [];
        $('#items-table tbody tr').each(function() {
            var $row = $(this);
            var $nameCell = $row.find('td:eq(1) a');
            window.monsterCache.push({
                id: $nameCell.attr('href').split('/').pop(),
                name: $nameCell.text(),
                class: $row.find('td:eq(2)').text(),
                element: $row
            });
        });
    }
</script>

<!-- Keyboard Navigation Script -->
<script>
    function initializeKeyboardNavigation() {
        $(document).keydown(function(e) {
            // Ctrl+F to focus search
            if (e.ctrlKey && e.keyCode === 70) {
                e.preventDefault();
                $('#monsterSearch').focus();
            }
            // Escape to clear search
            if (e.keyCode === 27) {
                $('#monsterSearch').val('').trigger('input');
                $('#searchSuggestions').hide();
            }
            // Left/Right arrows for pagination when not in search
            if (!$('#monsterSearch').is(':focus')) {
                if (e.keyCode === 37) { // Left arrow
                    window.table.page('previous').draw('page');
                } else if (e.keyCode === 39) { // Right arrow
                    window.table.page('next').draw('page');
                }
            }
        });

        // Input event for search suggestions
        $('#monsterSearch').on('input', function() {
            const query = $(this).val().trim();
            const suggestions = $('#searchSuggestions');

            if (query) {
                // Fetch and display suggestions (replace with actual data-fetching logic)
                const mockSuggestions = ['Item 1', 'Item 2', 'Item 3']
                    .filter(item => item.toLowerCase().includes(query.toLowerCase()))
                    .map(item => `<div class="suggestion-item p-2">${item}</div>`)
                    .join('');
                
                suggestions.html(mockSuggestions).show();
            } else {
                suggestions.hide();
            }
        });

        // Clear search on button click
        $('#clearSearch').on('click', function() {
            $('#monsterSearch').val('').trigger('input');
            $('#searchSuggestions').hide();
        });

        // Suggestion click handler (optional)
        $('#searchSuggestions').on('click', '.suggestion-item', function() {
            const selected = $(this).text();
            $('#monsterSearch').val(selected);
            $('#searchSuggestions').hide();
        });
    }

    $(document).ready(function() {
        initializeKeyboardNavigation();
    });
</script>

<!-- Export Functionality Script -->
<script>
    $(document).ready(function() {
        $('#export-csv').click(function() {
            $('.loading-spinner').fadeIn();

            setTimeout(function() {
                var csvContent = "data:text/csv;charset=utf-8,\uFEFF";

                var headers = [];
                $('#items-table thead th').each(function() {
                    headers.push('"' + $(this).text() + '"');
                });
                csvContent += headers.join(",") + "\n";

                $('#items-table tbody tr').each(function() {
                    var row = [];
                    $(this).find('td').each(function(index) {
                        if (index === 0) {
                            row.push('""');
                        } else {
                            row.push('"' + $(this).text() + '"');
                        }
                    });
                    csvContent += row.join(",") + "\n";
                });

                var encodedUri = encodeURI(csvContent);
                var link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "monsters_" + new Date().toISOString().slice(0,10) + ".csv");
                document.body.appendChild(link);

                link.click();
                document.body.removeChild(link);
                $('.loading-spinner').fadeOut();
            }, 100);
        });
    });
</script>

<!-- Dropdown Menu Script -->
<script>
    $(document).ready(function() {
        let timeout;
        const DELAY = 300;

        $('.nav-item.dropdown').hover(
            function() {
                clearTimeout(timeout);
                const $dropdown = $(this);
                $('.nav-item.dropdown').not($dropdown).find('.dropdown-menu').hide();
                $dropdown.find('.dropdown-menu').show();
            },
            function() {
                const $dropdown = $(this);
                timeout = setTimeout(function() {
                    if (!$dropdown.find('.dropdown-menu:hover').length) {
                        $dropdown.find('.dropdown-menu').hide();
                    }
                }, DELAY);
            }
        );

        $('.dropdown-menu').hover(
            function() {
                clearTimeout(timeout);
            },
            function() {
                const $menu = $(this);
                timeout = setTimeout(function() {
                    $menu.hide();
                }, DELAY);
            }
        );

        $('.dropdown-item').click(function(e) {
            const href = $(this).attr('href');
            if (href) {
                window.location.href = href;
            }
        });
    });
</script>

<!-- Window Resize Handler Script 
<script>
    $(document).ready(function() {
        $(window).resize(_.debounce(function() {
            window.table.columns.adjust();
        }, 250));
    });
</script>
-->


<!-- Tooltip Initialization Script -->
<script>
    $(document).ready(function() {
        $('[data-toggle="tooltip"]').tooltip();
    });
</script>





<!-- Inline Theme Check Script - Place in <head> -->
<script>
    // Немедленно проверяем и применяем тему до загрузки DOM
    (function() {
        if (localStorage.getItem('theme') === 'dark') {
            document.documentElement.classList.add('dark-theme');
            document.body.classList.add('dark-theme');
        }
    })();
</script>

<!-- Dark Theme Toggle Script -->
<script>
    document.getElementById('theme-toggle').addEventListener('click', () => {
        document.documentElement.classList.toggle('dark-theme');
        document.body.classList.toggle('dark-theme');
        localStorage.setItem('theme',
            document.documentElement.classList.contains('dark-theme') ? 'dark' : 'light'
        );
    });
</script>


<!-- SpoilerConfig -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.skill-section').forEach(section => {
            const title = section.querySelector('.section-title');
            const content = section.querySelector('.skill-content');
            
            if (title && content) {
                // Create wrapper for content
                const contentWrapper = document.createElement('div');
                contentWrapper.className = 'skill-content-wrapper';
                content.parentNode.insertBefore(contentWrapper, content);
                contentWrapper.appendChild(content);
                
                // Create header structure
                const header = document.createElement('div');
                header.className = 'skill-header';
                
                const titleWrapper = document.createElement('div');
                titleWrapper.className = 'skill-title-wrapper';
                
                const toggle = document.createElement('div');
                toggle.className = 'skill-toggle';
                
                // Move the title into the new structure
                title.parentNode.removeChild(title);
                titleWrapper.appendChild(title);
                header.appendChild(titleWrapper);
                header.appendChild(toggle);
                
                // Insert the header before the content wrapper
                contentWrapper.parentNode.insertBefore(header, contentWrapper);
                
                // Set initial height
                contentWrapper.style.height = content.offsetHeight + 'px';
                
                // Add click handler
                header.addEventListener('click', function() {
                    const isCollapsed = section.classList.contains('collapsed');
                    
                    if (isCollapsed) {
                        // Get height before expanding
                        contentWrapper.style.height = content.offsetHeight + 'px';
                        section.classList.remove('collapsed');
                    } else {
                        contentWrapper.style.height = content.offsetHeight + 'px';
                        // Force reflow
                        contentWrapper.offsetHeight;
                        section.classList.add('collapsed');
                    }
                });
                
                // Add resize observer to handle content changes
                const resizeObserver = new ResizeObserver(entries => {
                    if (!section.classList.contains('collapsed')) {
                        contentWrapper.style.height = content.offsetHeight + 'px';
                    }
                });
                
                resizeObserver.observe(content);
            }
        });
    });
</script>

<!-- Функции поиска -->
<script>
    // Функция инициализации поиска
    function initializeSearch() {
        const searchInput = document.getElementById('monsterSearch');
        const suggestionsContainer = document.getElementById('searchSuggestions');
        const clearButton = document.getElementById('clearSearch');
        let searchDebounceTimer;
    
        if (!searchInput || !suggestionsContainer || !clearButton) return;
    
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.trim().toLowerCase();
            clearTimeout(searchDebounceTimer);
    
            if (searchTerm === '') {
                suggestionsContainer.style.display = 'none';
                app.applyFilters(1);
                return;
            }
    
            searchDebounceTimer = setTimeout(() => {
                const suggestions = findSuggestions(searchTerm);
                displaySuggestions(suggestions, searchTerm);
                app.applyFilters(1);
            }, 300);
        });
    
        clearButton.addEventListener('click', () => {
            searchInput.value = '';
            suggestionsContainer.style.display = 'none';
            app.applyFilters(1);
        });
    
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-container')) {
                suggestionsContainer.style.display = 'none';
            }
        });
    }
    
    // Поиск подходящих монстров
    function findSuggestions(searchTerm) {
        const monsters = app?.stateManager?.getState('cachedData')?.monsters;
        if (!monsters) return [];
    
        return monsters
            .filter(monster => {
                const matchesId = monster.MID.toString().toLowerCase().includes(searchTerm);
                const matchesName = monster.MName.toLowerCase().includes(searchTerm);
                return matchesId || matchesName;
            })
            .slice(0, 8);
    }
    
    // Отображение подсказок
    function displaySuggestions(suggestions, searchTerm) {
        const suggestionsContainer = document.getElementById('searchSuggestions');
        if (!suggestionsContainer) return;
    
        if (!suggestions.length) {
            suggestionsContainer.style.display = 'none';
            return;
        }
    
        const resources = app?.stateManager?.getState('cachedData')?.resources || {};
        
        const suggestionsHtml = suggestions.map(monster => {
            const monsterName = highlightMatch(monster.MName, searchTerm);
            const monsterMID = highlightMatch(monster.MID.toString(), searchTerm);
            const imageUrl = resources[monster.MID] || CONSTANTS.FALLBACK_IMAGE;
            
            return `
                <a href="/monster/${monster.MID}" class="search-suggestion" data-id="${monster.MID}">
                    <img src="${imageUrl}" alt="${monster.MName}" onerror="this.src='${CONSTANTS.FALLBACK_IMAGE}';">
                    <span>[${monsterMID}] ${monsterName}</span>
                </a>
            `;
        }).join('');
    
        suggestionsContainer.innerHTML = suggestionsHtml;
        suggestionsContainer.style.display = 'block';
    }
    
    // Подсветка совпадений
    function highlightMatch(text, searchTerm) {
        if (!searchTerm) return text;
        const escapedSearchTerm = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); 
        const regex = new RegExp(`(${escapedSearchTerm})`, 'gi');
        return text.replace(regex, '<span class="highlight">$1</span>');
    }
    
    
    // FilterManager с поддержкой поиска
    FilterManager.filterData = function(monsters, filters) {
        const searchTerm = document.getElementById('monsterSearch')?.value.trim().toLowerCase();
    
        // Применяем поисковый фильтр перед остальными фильтрами
        let filteredData = monsters;
        if (searchTerm) {
            filteredData = monsters.filter(monster => {
                const matchesId = monster.MID.toString().toLowerCase().includes(searchTerm);
                const matchesName = monster.MName.toLowerCase().includes(searchTerm);
                return matchesId || matchesName;
            });
        }
    
        // Применяем остальные фильтры
        return filteredData.filter(monster => 
            FilterManager._applyAllFilters(monster, filters));
    }
</script>
<!-- Filters container -->
<div class="filters-container mb-4">
    <div class="row">
        <!-- Main filter buttons -->
        <div class="col-md-12">
            <button class="btn btn-primary mb-3" type="button" data-toggle="collapse" data-target="#mainFilters">
                <i class="fas fa-filter"></i> –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
            </button>
            <button class="btn btn-secondary mb-3 ml-2" type="button" data-toggle="collapse" data-target="#advancedFilters">
                <i class="fas fa-sliders-h"></i> –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
            </button>
            <button class="btn btn-info mb-3 ml-2" id="resetFilters">
                <i class="fas fa-sync"></i> –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
            </button>
            <button class="theme-toggle" id="theme-toggle">
                <i class="fas fa-moon"></i>
            </button>
            <select id="perPageSelect" class="form-control same-width-as-reset"></select>
        </div>

        <!-- Search -->
        <div class="col-md-12 mb-3">
            <div class="search-container position-relative">
                <div class="input-group">
                    <input type="text" 
                        class="form-control" 
                        id="monsterSearch" 
                        placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ ID –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—é –º–æ–Ω—Å—Ç—Ä–∞..."
                        autocomplete="off">
                    <div class="input-group-append">
                        <button class="btn btn-outline-secondary" type="button" id="clearSearch">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div id="searchSuggestions" class="position-absolute w-100 bg-white border rounded-bottom shadow-sm" 
                    style="display: none; z-index: 1000; max-height: 300px; overflow-y: auto;"></div>
            </div>
        </div>

        <!-- Main Filters -->
        <div class="col-12 collapse" id="mainFilters">
            <div class="card card-body mb-3 filter-card-container">
                <div class="filterrow">
                    <!-- Monster Class -->
                    <div class="col-md-3 mb-3">
                        <div class="filter-group">
                            <label for="classFilter" class="filter-label">
                                <i class="fas fa-dragon me-2"></i>–ö–ª–∞—Å—Å –º–æ–Ω—Å—Ç—Ä–∞
                            </label>
                            <select class="form-control custom-select filter-select" id="classFilter">
                                <option value="">–í—Å–µ –∫–ª–∞—Å—Å—ã</option>
                                    <!-- –ö–ª–∞—Å—Å—ã —Å–∞–º–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤—è—Ç—Å—è -->
                            </select>
                        </div>
                    </div>

                    <!-- Monster Level -->
                    <div class="col-md-3 mb-3">
                        <div class="filter-group">
                            <label class="filter-label">
                                <i class="fas fa-layer-group me-2"></i>–£—Ä–æ–≤–µ–Ω—å
                            </label>
                            <div class="input-group filter-range">
                                <input type="number" class="form-control" id="levelMin" placeholder="–ú–∏–Ω">
                                <span class="input-group-text range-separator">
                                    <i class="fas fa-arrows-alt-h"></i>
                                </span>
                                <input type="number" class="form-control" id="levelMax" placeholder="–ú–∞–∫—Å">
                            </div>
                        </div>
                    </div>

                    <!-- Race Type -->
                    <div class="col-md-3 mb-3">
                        <div class="filter-group">
                            <label for="raceFilter" class="filter-label">
                                <i class="fas fa-users me-2"></i>–†–∞—Å–∞
                            </label>
                            <select class="form-control custom-select filter-select" id="raceFilter">
                                <option value="">–í—Å–µ —Ä–∞—Å—ã</option>
                                <option value="1">üë§ –ß–µ–ª–æ–≤–µ–∫</option>
                                <option value="2">üíÄ –ù–µ–∂–∏—Ç—å</option>
                                <option value="3">üòà –î–µ–º–æ–Ω</option>
                                <option value="4">üêæ –ñ–∏–≤–æ—Ç–Ω–æ–µ</option>
                            </select>
                        </div>
                    </div>

                    <!-- Attack Type -->
                    <div class="col-md-3 mb-3">
                        <div class="filter-group">
                            <label for="attackTypeFilter" class="filter-label">
                                <i class="fas fa-fist-raised me-2"></i>–¢–∏–ø –∞—Ç–∞–∫–∏
                            </label>
                            <select class="form-control custom-select filter-select" id="attackTypeFilter">
                                <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                                <option value="1">‚öîÔ∏è –§–∏–∑–∏—á–µ—Å–∫–∏–π</option>
                                <option value="2">‚ú® –ú–∞–≥–∏—á–µ—Å–∫–∏–π</option>
                                <option value="3">üîÆ –°–º–µ—à–∞–Ω–Ω—ã–π</option>
                            </select>
                        </div>
                    </div>


                    <!-- RespawnTime 
                    <div class="col-md-3 mb-3">
                        <div class="filter-group">
                            <label class="filter-label">
                                <i class="fas fa-star me-2"></i>–í—Ä–µ–º—è –≤–æ–∑—Ä–æ–∂–¥–µ–Ω–∏—è
                            </label>
                            <div class="input-group filter-range">
                                <input type="number" class="form-control" id="tickMin" placeholder="–ú–∏–Ω">
                                <span class="input-group-text range-separator">
                                    <i class="fas fa-arrows-alt-h"></i>
                                </span>
                                <input type="number" class="form-control" id="tickMax" placeholder="–ú–∞–∫—Å">
                            </div>
                        </div>
                    </div>
                    -->

                    <!-- Experience -->
                    <div class="col-md-3 mb-3">
                        <div class="filter-group">
                            <label class="filter-label">
                                <i class="fas fa-star me-2"></i>–û–ø—ã—Ç
                            </label>
                            <div class="input-group filter-range">
                                <input type="number" class="form-control" id="expMin" placeholder="–ú–∏–Ω">
                                <span class="input-group-text range-separator">
                                    <i class="fas fa-arrows-alt-h"></i>
                                </span>
                                <input type="number" class="form-control" id="expMax" placeholder="–ú–∞–∫—Å">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Checkboxes -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="filter-toggles">
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="eventMonsterFilter">
                                <label class="custom-control-label" for="eventMonsterFilter">
                                    <i class="fas fa-calendar-alt"></i> –ò–≤–µ–Ω—Ç–æ–≤—ã–π
                                </label>
                            </div>
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="testMonsterFilter">
                                <label class="custom-control-label" for="testMonsterFilter">
                                    <i class="fas fa-vial"></i> –¢–µ—Å—Ç–æ–≤—ã–π
                                </label>
                            </div>
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="showHpFilter">
                                <label class="custom-control-label" for="showHpFilter">
                                    <i class="fas fa-heart"></i> –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç HP –≤ –∏–≥—Ä–µ
                                </label>
                            </div>

                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="showAgressiveFilter">
                                <label class="custom-control-label" for="showAgressiveFilter">
                                    <i class="fa-solid fa-face-angry"></i> –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–æ—Å—Ç—å
                                </label>
                            </div>

                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="showAgressiveVoplotFilter">
                                <label class="custom-control-label" for="showAgressiveVoplotFilter">
                                    <i class="fa-regular fa-face-angry"></i> –ê–≥—Ä. –Ω–∞ –ø–µ—Ä–µ–≤–æ–ø–ª–æ—â–µ–Ω–∏–µ
                                </label>
                            </div>

                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="showAgressiveInvisFilter">
                                <label class="custom-control-label" for="showAgressiveInvisFilter">
                                    <i class="fa-regular fa-face-tired"></i> –ê–≥—Ä. –Ω–∞ –Ω–µ–≤–∏–¥–∏–º–æ—Å—Ç—å
                                </label>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Advanced Filters -->
        <div class="col-12 collapse" id="advancedFilters">
            <div class="card card-body">
                <div class="row">
                    <div class="col-12">
                        <div class="advanced-filters-grid">
                            <!-- Will be filled dynamically with JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Status and pagination -->
<div id="totalCount" class="mb-3 mt-3">–ù–∞–π–¥–µ–Ω–æ –º–æ–Ω—Å—Ç—Ä–æ–≤: 0</div>
<div class="pagination-container mb-4 d-flex justify-content-center gap-2"></div>

<!-- Loading overlay and messages -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="loading-content">
        <div class="spinner"></div>
        <span>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</span>
    </div>
</div>
<div id="errorMessage" class="message-container error-message"></div>

<script>
    // Constants and configurations
    const CONSTANTS = {
        DEBOUNCE_DELAY: 300,
        DEFAULT_PER_PAGE: 25,
        FALLBACK_IMAGE: 'https://raw.githubusercontent.com/Aksel911/R2-HTML-DB/main/static/no_monster/no_monster_image.png',
        PAGINATION_RADIUS: 2,
        ERROR_DISPLAY_TIME: 5000
    };

    const MONSTER_CLASS_DESCRIPTIONS = {
        1: 'A –∫–ª–∞—Å—Å', 2: 'B –∫–ª–∞—Å—Å', 3: 'C –∫–ª–∞—Å—Å', 4: 'D –∫–ª–∞—Å—Å',
        5: 'E –∫–ª–∞—Å—Å', 6: 'F –∫–ª–∞—Å—Å', 7: 'G –∫–ª–∞—Å—Å', 8: 'H –∫–ª–∞—Å—Å',
        9: 'I –∫–ª–∞—Å—Å', 10: 'J –∫–ª–∞—Å—Å', 11: 'K –∫–ª–∞—Å—Å', 12: 'L –∫–ª–∞—Å—Å',
        13: 'M –∫–ª–∞—Å—Å', 14: 'N –∫–ª–∞—Å—Å', 15: 'O –∫–ª–∞—Å—Å', 16: 'P –∫–ª–∞—Å—Å',
        17: 'Q –∫–ª–∞—Å—Å', 18: 'R –∫–ª–∞—Å—Å', 19: 'S –∫–ª–∞—Å—Å', 20: 'T –∫–ª–∞—Å—Å',
        21: 'U –∫–ª–∞—Å—Å', 22: 'V –∫–ª–∞—Å—Å', 23: 'NPC', 24: 'W –∫–ª–∞—Å—Å',
        25: 'X –∫–ª–∞—Å—Å', 26: '–û—Å–æ–±—ã–π –ú–æ–Ω—Å—Ç—Ä', 27: '–°–æ–±—ã—Ç–∏–µ',
        28: '–ò–º–µ–Ω–Ω–æ–π', 29: '–ë–æ—Å—Å', 31: 'S', 32: '–ù–∞–ª–µ—Ç—á–∏–∫–∏',
        33: '–≠–ø–∏–∫ –ú–æ–±—ã (–¥–µ–º)', 34: '–≠–ø–∏–∫ –ë–æ—Å—Å—ã (–¥–µ–º)', 35: '–°—Ç–∞—Ç—É—è',
        36: '–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª–∏ (–•–¢–ñ –ë–æ—Å—Å—ã)', 37: '–†–∞–∑—ä—è—Ä–µ–Ω–Ω—ã–µ –ë–æ—Å—Å—ã',
        38: '–ü–∞–¥—à–∏–µ –ë–æ—Å—Å—ã'
    };

    const MONSTER_TYPE_MAPPINGS = {
        '/monster_regular': [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22],
        '/monster_boss': [29, 38, 37, 36, 34],
        '/monster_raidboss': [26],
        '/monster_imennoy': [28],
        '/monster_npc': [23],
        '/monster_event': [27]
    };

    const RACE_TYPES = {
        1: '–ß–µ–ª–æ–≤–µ–∫',
        2: '–ù–µ–∂–∏—Ç—å',
        3: '–î–µ–º–æ–Ω',
        4: '–ñ–∏–≤–æ—Ç–Ω–æ–µ'
    };

    const ADVANCED_FILTERS = [
        { id: 'MHIT', label: '–¢–æ—á–Ω–æ—Å—Ç—å', icon: 'üéØ' },
        { id: 'MMinD', label: '–ú–∏–Ω. —É—Ä–æ–Ω', icon: '‚öîÔ∏è' },
        { id: 'MMaxD', label: '–ú–∞–∫—Å. —É—Ä–æ–Ω', icon: '‚öîÔ∏è' },
        { id: 'MHP', label: 'HP', icon: '‚ù§Ô∏è' },
        { id: 'MMP', label: 'MP', icon: 'üíß' },
        { id: 'MAttackRateOrg', label: '–°–∫–æ—Ä–æ—Å—Ç—å –∞—Ç–∞–∫–∏', icon: '‚ö°' },
        { id: 'MMoveRateOrg', label: '–°–∫–æ—Ä–æ—Å—Ç—å –ø–µ—Ä–µ–¥–≤–∏–∂–µ–Ω–∏—è', icon: 'üèÉ' },
        { id: 'MMoveRange', label: '–†–∞–¥–∏—É—Å –ø—Ä–µ—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è', icon: 'üìè' },
        { id: 'mSightRange', label: '–†–∞–¥–∏—É—Å –æ–±–∑–æ—Ä–∞', icon: 'üëÅÔ∏è' },
        { id: 'mAttackRange', label: '–î–∞–ª—å–Ω–æ—Å—Ç—å –∞—Ç–∞–∫–∏', icon: 'üéØ' },
        { id: 'mSkillRange', label: '–î–∞–ª—å–Ω–æ—Å—Ç—å –Ω–∞–≤—ã–∫–æ–≤', icon: '‚ú®' },
        { id: 'mScale', label: '–†–∞–∑–º–µ—Ä –º–æ–¥–µ–ª–∏', icon: 'üìê' },
        { id: 'mHPRegen', label: '–†–µ–≥–µ–Ω HP', icon: '‚ô•Ô∏è' },
        { id: 'mMPRegen', label: '–†–µ–≥–µ–Ω MP', icon: 'üí´' },
        { id: 'mVolitionOfHonor', label: '–û—á–∫–∏ —á–µ—Å—Ç–∏', icon: 'üèÜ' }
    ];

    // State Management
    class StateManager {
        constructor() {
            this._state = {
                currentPage: 1,
                cachedData: null,
                debounceTimer: null,
                isLoading: false,
                error: null
            };
            
            this._subscribers = new Set();
        }

        setState(key, value) {
            const oldValue = this._state[key];
            this._state[key] = value;
            
            if (oldValue !== value) {
                this._notifySubscribers(key, value, oldValue);
            }
        }

        getState(key) {
            return this._state[key];
        }

        subscribe(callback) {
            this._subscribers.add(callback);
            return () => this._subscribers.delete(callback);
        }

        _notifySubscribers(key, newValue, oldValue) {
            this._subscribers.forEach(callback => 
                callback(key, newValue, oldValue));
        }
    }

    // Data Service
    class DataService {
        constructor(stateManager) {
            this.stateManager = stateManager;
        }

        async fetchData(forceReload = false) {
            const cachedData = this.stateManager.getState('cachedData');
            if (cachedData && !forceReload) {
                return cachedData;
            }

            this.stateManager.setState('isLoading', true);

            try {
                const response = await fetch(`${window.location.pathname}?all=1`, {
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                if (data.error) {
                    throw new Error(data.error);
                }

                this.stateManager.setState('cachedData', data);
                return data;

            } catch (error) {
                this.stateManager.setState('error', error.message);
                return null;
            } finally {
                this.stateManager.setState('isLoading', false);
            }
        }
    }

    // Filter Logic
    class FilterManager {
        static collectFilters() {
            const filters = {};
            
            document.querySelectorAll('.form-control, .custom-control-input').forEach(input => {
                if (input.id === 'perPageSelect') return;
                
                let value = input.type === 'checkbox' ? input.checked : input.value.trim();
                
                if (value !== '' && value !== false) {
                    if (input.type === 'checkbox' && value === true) {
                        value = '1';
                    }
    
                    // Map input IDs to correct field names
                    switch(input.id) {
                        case 'levelMin':
                            filters['mLevelMin'] = value;
                            break;
                        case 'levelMax':
                            filters['mLevelMax'] = value;
                            break;
                        case 'expMin':
                            filters['MExpMin'] = value;
                            break;
                        case 'expMax':
                            filters['MExpMax'] = value;
                            break;
                        case 'tickMin':
                            filters['mTickMin'] = value;
                            break;
                        case 'tickMax':
                            filters['mTickMax'] = value;
                            break;
                        default:
                            filters[input.id] = value;
                    }
                }
            });
    
            // Debug log
            console.log('Collected filters:', filters);
            return filters;
        }
    

        static filterData(monsters, filters) {
            return monsters.filter(monster => 
                this._applyAllFilters(monster, filters));
        }

        static _applyAllFilters(monster, filters) {
            return Object.entries(filters).every(([key, value]) => {
                if (!value || value === '') return true;
    
                // Let server handle tick filtering
                if (key === 'mTickMin' || key === 'mTickMax') return true;
    
                if (key.endsWith('Min') || key.endsWith('Max')) {
                    return this._applyRangeFilter(monster, key, value);
                }
                return this._applyBasicFilter(monster, key, value);
            });
        }

        static _applyRangeFilter(monster, key, value) {
            // Map filter keys to monster properties
            let baseKey = key.replace(/(Min|Max)$/, '');
            const isMin = key.endsWith('Min');
            let monsterValue;
    
            switch(baseKey) {
                case 'mLevel':
                    monsterValue = monster.mLevel;
                    break;
                case 'MExp':
                    monsterValue = monster.MExp;
                    break;
                default:
                    monsterValue = monster[baseKey];
            }
    
            monsterValue = Number(monsterValue) || 0;
            const filterValue = Number(value);
    
            if (isNaN(filterValue)) return true;
            return isMin ? monsterValue >= filterValue : monsterValue <= filterValue;
        }

        static _applyBasicFilter(monster, key, value) {
            switch(key) {
                case 'classFilter':
                    return monster.MClass === Number(value);
                case 'raceFilter':
                    return monster.MRaceType === Number(value);
                case 'attackTypeFilter':
                    return monster.mAttackType === Number(value);
                case 'eventMonsterFilter':
                    return Boolean(monster.mIsEvent);
                case 'testMonsterFilter':
                    return Boolean(monster.mIsTest);
                case 'showHpFilter':
                    return Boolean(monster.mIsShowHp);
                default:
                    return true;
            }
        }
    }

    // UI Management
    class UIManager {
        constructor(stateManager) {
            this.stateManager = stateManager;
            this.setupStateSubscriptions();
        }

        setupStateSubscriptions() {
            this.stateManager.subscribe((key, value) => {
                switch(key) {
                    case 'isLoading':
                        this.toggleLoadingState(value);
                        break;
                    case 'error':
                        if (value) this.showError(value);
                        break;
                }
            });
        }

        initializeUI() {
            this.initializeAdvancedFilters();
            this.initializePerPageSelect();
            this.setupEventListeners();
            this.initializeTypeFilter();
        }

        initializeAdvancedFilters() {
            const container = document.querySelector('.advanced-filters-grid');
            if (!container) return;

            container.innerHTML = ADVANCED_FILTERS
                .map(this.createFilterCard)
                .join('');
        }

        createFilterCard(filter) {
            return `
                <div class="filter-card" data-filter="${filter.id}">
                    <div class="filter-card-header">
                        <span class="filter-icon">${filter.icon}</span>
                        <span class="filter-label">${filter.label}</span>
                    </div>
                    <div class="filter-inputs">
                        <div class="input-group">
                            <input type="number" 
                                class="form-control" 
                                id="${filter.id}Min" 
                                placeholder="–ú–∏–Ω" 
                                step="any">
                            <div class="input-group-text">-</div>
                            <input type="number" 
                                class="form-control" 
                                id="${filter.id}Max" 
                                placeholder="–ú–∞–∫—Å" 
                                step="any">
                        </div>
                    </div>
                </div>
            `;
        }

        setupEventListeners() {
            const filtersContainer = document.querySelector('.filters-container');
            if (filtersContainer) {
                filtersContainer.addEventListener('input', this._handleFilterInput.bind(this));
            }

            const resetButton = document.getElementById('resetFilters');
            if (resetButton) {
                resetButton.addEventListener('click', this._handleResetFilters.bind(this));
            }

            const perPageSelect = document.getElementById('perPageSelect');
            if (perPageSelect) {
                perPageSelect.addEventListener('change', () => {
                    this.stateManager.setState('currentPage', 1);
                    this._triggerFiltersUpdate();
                });
            }
        }

        _handleFilterInput(event) {
            if (event.target.classList.contains('form-control') || 
                event.target.classList.contains('custom-control-input')) {
                
                clearTimeout(this.stateManager.getState('debounceTimer'));
                
                const timer = setTimeout(
                    () => this._triggerFiltersUpdate(), 
                    CONSTANTS.DEBOUNCE_DELAY
                );
                
                this.stateManager.setState('debounceTimer', timer);
            }
        }

        _handleResetFilters() {
            document.querySelectorAll('.form-control, .custom-control-input')
                .forEach(input => {
                    if (input.type === 'checkbox') {
                        input.checked = false;
                    } else if (input.id !== 'perPageSelect') {
                        input.value = '';
                    }
                });
            
            this._triggerFiltersUpdate();
        }

        _triggerFiltersUpdate() {
            const event = new CustomEvent('filtersUpdated');
            document.dispatchEvent(event);
        }

        initializeTypeFilter() {
            const typeFilter = document.getElementById('classFilter');
            if (!typeFilter) return;

            const allowedTypes = this._getAllowedTypes();
            typeFilter.innerHTML = '<option value="">–í—Å–µ</option>';

            (allowedTypes.length ? allowedTypes : Object.keys(MONSTER_CLASS_DESCRIPTIONS))
                .forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = MONSTER_CLASS_DESCRIPTIONS[type] || `–ö–ª–∞—Å—Å ${type}`;
                    typeFilter.appendChild(option);
                });
        }

        _getAllowedTypes() {
            return MONSTER_TYPE_MAPPINGS[window.location.pathname] || [];
        }

        initializePerPageSelect() {
            const perPageSelect = document.getElementById('perPageSelect');
            if (!perPageSelect) return;

            const options = [10, 25, 50, 75, 100];
            perPageSelect.innerHTML = options
                .map(n => `<option value="${n}">${n} –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ</option>`)
                .join('');
            
            perPageSelect.value = CONSTANTS.DEFAULT_PER_PAGE.toString();
        }

        renderMonsters(monsters) {
            const tableBody = document.querySelector('table tbody');
            if (!tableBody) return;
            const cachedData = this.stateManager.getState('cachedData');
            
            const monstersHTML_table_headers = '{% block table_headers %}\n\t<th>üñºÔ∏è</th>\n\t<th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>\n\t<th>–£—Ä–æ–≤–µ–Ω—å</th>\n\t<th>–ö–ª–∞—Å—Å</th>\n\t<th>MExp</th>\n\t<th>MHP</th>\n\t<th>MRaceType</th>\n{% endblock %}';
            
            const monstersHTML = monsters
                .map(monster => this._createMonsterRow(monster, cachedData.resources))
                .join('');
            
            tableBody.innerHTML = monstersHTML_table_headers + monstersHTML;
        }

        _createMonsterRow(monster, resources) {
            return `
                <tr>
                    <td>
                        <div class="hover-text-wrapper">
                            <a href="/monster/${monster.MID}">
                                <img src="${resources[monster.MID] || CONSTANTS.FALLBACK_IMAGE}"
                                    alt="${monster.MName}"
                                    title="${monster.MName}"
                                    width="48"
                                    height="48"
                                    loading="lazy"
                                    class="monster-image"
                                    onerror="this.src='${CONSTANTS.FALLBACK_IMAGE}';">
                            </a>
                            <div class="hover-text">[${monster.MID}] ${monster.MName}</div>
                        </div>
                    </td>
                    <td>
                        <div class="monster-name">
                            <a href="/monster/${monster.MID}">${monster.MName}</a>
                        </div>
                    </td>
                    <td>${monster.mLevel || '0'}</td>
                    <td>${MONSTER_CLASS_DESCRIPTIONS[monster.MClass] || 'N/A'}</td>
                    <td>${monster.MExp || '0'}</td>
                    <td>${monster.MHP || 'N/A'}</td>
                    <td>${RACE_TYPES[monster.MRaceType] || 'N/A'}</td>
                </tr>
            `;
        }

        createPagination(total, currentPage, perPage) {
            const paginationContainer = document.querySelector('.pagination-container');
            if (!paginationContainer) return;

            const totalPages = Math.ceil(total / perPage);
            const paginationHTML = [];

            // Previous button
            paginationHTML.push(this._createPaginationButton(
                '–ü—Ä–µ–¥—ã–¥—É—â–∞—è',
                currentPage - 1,
                currentPage === 1
            ));

            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (this._shouldShowPageNumber(i, currentPage, totalPages)) {
                    paginationHTML.push(this._createPaginationButton(
                        i.toString(),
                        i,
                        false,
                        i === currentPage
                    ));
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    paginationHTML.push('<span class="pagination-ellipsis">...</span>');
                }
            }

            // Next button
            paginationHTML.push(this._createPaginationButton(
                '–°–ª–µ–¥—É—é—â–∞—è',
                currentPage + 1,
                currentPage === totalPages
            ));

            paginationContainer.innerHTML = paginationHTML.join('');
        }

        _shouldShowPageNumber(pageNum, currentPage, totalPages) {
            return pageNum === 1 || 
                pageNum === totalPages || 
                (pageNum >= currentPage - CONSTANTS.PAGINATION_RADIUS && 
                    pageNum <= currentPage + CONSTANTS.PAGINATION_RADIUS);
        }

        _createPaginationButton(text, pageNum, isDisabled, isActive = false) {
            const className = isActive ? 'btn-primary' : 'btn-secondary';
            const disabled = isDisabled ? 'disabled' : '';
            return `
                <button class="btn ${className} ${disabled}"
                        onclick="app.applyFilters(${pageNum})"
                        ${disabled}>
                    ${text}
                </button>
            `;
        }

        updateTotalCount(count) {
            const totalCount = document.getElementById('totalCount');
            if (totalCount) {
                totalCount.textContent = `–ù–∞–π–¥–µ–Ω–æ –º–æ–Ω—Å—Ç—Ä–æ–≤: ${count}`;
            }
        }

        updateURL(params) {
            const url = new URL(window.location.href);
            url.search = new URLSearchParams(params).toString();
            history.pushState({}, '', url);
        }

        toggleLoadingState(isLoading) {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (!loadingOverlay) return;

            if (isLoading) {
                loadingOverlay.classList.add('show');
            } else {
                setTimeout(() => {
                    loadingOverlay.classList.remove('show');
                }, 500);
            }
        }

        showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            if (!errorMessage) return;

            errorMessage.textContent = `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ${message}`;
            errorMessage.classList.add('show');

            setTimeout(() => {
                errorMessage.classList.remove('show');
            }, CONSTANTS.ERROR_DISPLAY_TIME);
        }
    }

    // Main Application Class
    class MonsterFilterApp {
        constructor() {
            this.stateManager = new StateManager();
            this.dataService = new DataService(this.stateManager);
            this.uiManager = new UIManager(this.stateManager);
        }

        async initialize() {
            await this.dataService.fetchData();
            this.uiManager.initializeUI();
            this.setupEventListeners();
            this.applyFilters(1);
            initializeSearch(); 
        }

        setupEventListeners() {
            document.addEventListener('filtersUpdated', () => {
                this.applyFilters(1);
            });
        }

        async applyFilters(page = 1) {
            const cachedData = this.stateManager.getState('cachedData');

            
            if (!cachedData) return;

            const filters = FilterManager.collectFilters();
            const filteredData = FilterManager.filterData(cachedData.monsters, filters);
            const perPage = this._getPerPage();
            
            this.stateManager.setState('currentPage', page);
            
            const paginatedData = this._paginateData(filteredData, page, perPage);
            
            this.uiManager.updateTotalCount(filteredData.length);
            this.uiManager.renderMonsters(paginatedData);
            this.uiManager.createPagination(filteredData.length, page, perPage);
            this.uiManager.updateURL(filters);
        }

        _getPerPage() {
            return Number(document.getElementById('perPageSelect')?.value) || 
                CONSTANTS.DEFAULT_PER_PAGE;
        }

        _paginateData(data, page, perPage) {
            const start = (page - 1) * perPage;
            return data.slice(start, start + perPage);
        }
    }

    // Initialize application
    let app;
    document.addEventListener('DOMContentLoaded', () => {
        app = new MonsterFilterApp();
        app.initialize();
    });

</script>





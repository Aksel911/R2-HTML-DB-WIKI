<!-- Keyboard Navigation Script -->
<script>
    function initializeKeyboardNavigation() {
        $(document).keydown(function(e) {
            // Ctrl+F to focus search
            if (e.ctrlKey && e.keyCode === 70) {
                e.preventDefault();
                $('#itemSearch').focus();
            }
            // Escape to clear search
            if (e.keyCode === 27) {
                $('#itemSearch').val('').trigger('input');
                $('#searchSuggestions').hide();
            }
            // Left/Right arrows for pagination when not in search
            if (!$('#itemSearch').is(':focus')) {
                if (e.keyCode === 37) { // Left arrow
                    window.table.page('previous').draw('page');
                } else if (e.keyCode === 39) { // Right arrow
                    window.table.page('next').draw('page');
                }
            }
        });

        // Input event for search suggestions
        $('#itemSearch').on('input', function() {
            const query = $(this).val().trim();
            const suggestions = $('#searchSuggestions');

            if (query) {
                // Fetch and display suggestions (replace with actual data-fetching logic)
                const mockSuggestions = ['Item 1', 'Item 2', 'Item 3']
                    .filter(item => item.toLowerCase().includes(query.toLowerCase()))
                    .map(item => `<div class="suggestion-item p-2">${item}</div>`)
                    .join('');
                
                suggestions.html(mockSuggestions).show();
            } else {
                suggestions.hide();
            }
        });

        // Clear search on button click
        $('#clearSearch').on('click', function() {
            $('#itemSearch').val('').trigger('input');
            $('#searchSuggestions').hide();
        });

        // Suggestion click handler (optional)
        $('#searchSuggestions').on('click', '.suggestion-item', function() {
            const selected = $(this).text();
            $('#itemSearch').val(selected);
            $('#searchSuggestions').hide();
        });
    }

    $(document).ready(function() {
        initializeKeyboardNavigation();
    });
</script>

<!-- Dropdown Menu Script -->
<script>
    $(document).ready(function() {
        let timeout;
        const DELAY = 300;
        $('.nav-item.dropdown').hover(function() {
            clearTimeout(timeout);
            const $dropdown = $(this);
            $('.nav-item.dropdown').not($dropdown).find('.dropdown-menu').hide();
            $dropdown.find('.dropdown-menu').show();
        }, function() {
            const $dropdown = $(this);
            timeout = setTimeout(function() {
                if(!$dropdown.find('.dropdown-menu:hover').length) {
                    $dropdown.find('.dropdown-menu').hide();
                }
            }, DELAY);
        });
        $('.dropdown-menu').hover(function() {
            clearTimeout(timeout);
        }, function() {
            const $menu = $(this);
            timeout = setTimeout(function() {
                $menu.hide();
            }, DELAY);
        });
        $('.dropdown-item').click(function(e) {
            const href = $(this).attr('href');
            if(href) {
                window.location.href = href;
            }
        });
    });
</script>

<!-- Window Resize Handler Script 
<script>
    $(window).resize(_.debounce(function() {
        window.table.columns.adjust();
    }, 250));
</script>
-->

<!-- Tooltip Initialization Script -->
<script>
    $(document).ready(function() {
        $('[data-toggle="tooltip"]').tooltip();
    });
</script>

<!-- Inline Theme Check Script - Place in <head> -->
<script>
    // Немедленно проверяем и применяем тему до загрузки DOM
    (function() {
        if(localStorage.getItem('theme') === 'dark') {
            document.documentElement.classList.add('dark-theme');
            document.body.classList.add('dark-theme');
        }
    })();
</script>

<!-- Dark Theme Toggle Script -->
<script>
    document.getElementById('theme-toggle').addEventListener('click', () => {
        // Toggle the theme classes
        document.documentElement.classList.toggle('dark-theme');
        document.body.classList.toggle('dark-theme');
        
        // Store the current theme in localStorage
        localStorage.setItem('theme', document.documentElement.classList.contains('dark-theme') ? 'dark' : 'light');
    });
</script>
<script>
    // Добавляем эффект движения фона от мышки
    document.addEventListener('mousemove', function(e) {
        const x = e.clientX / window.innerWidth;
        const y = e.clientY / window.innerHeight;
        document.body.style.backgroundPosition = `${x * 100}% ${y * 100}%`;
    });
</script>

<!-- SpoilerConfig -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.skill-section').forEach(section => {
            const title = section.querySelector('.section-title');
            const content = section.querySelector('.skill-content');
            
            if (title && content) {
                // Create wrapper for content
                const contentWrapper = document.createElement('div');
                contentWrapper.className = 'skill-content-wrapper';
                content.parentNode.insertBefore(contentWrapper, content);
                contentWrapper.appendChild(content);
                
                // Create header structure
                const header = document.createElement('div');
                header.className = 'skill-header';
                
                const titleWrapper = document.createElement('div');
                titleWrapper.className = 'skill-title-wrapper';
                
                const toggle = document.createElement('div');
                toggle.className = 'skill-toggle';
                
                // Move the title into the new structure
                title.parentNode.removeChild(title);
                titleWrapper.appendChild(title);
                header.appendChild(titleWrapper);
                header.appendChild(toggle);
                
                // Insert the header before the content wrapper
                contentWrapper.parentNode.insertBefore(header, contentWrapper);
                
                // Set initial height
                contentWrapper.style.height = content.offsetHeight + 'px';
                
                // Add click handler
                header.addEventListener('click', function() {
                    const isCollapsed = section.classList.contains('collapsed');
                    
                    if (isCollapsed) {
                        // Get height before expanding
                        contentWrapper.style.height = content.offsetHeight + 'px';
                        section.classList.remove('collapsed');
                    } else {
                        contentWrapper.style.height = content.offsetHeight + 'px';
                        // Force reflow
                        contentWrapper.offsetHeight;
                        section.classList.add('collapsed');
                    }
                });
                
                // Add resize observer to handle content changes
                const resizeObserver = new ResizeObserver(entries => {
                    if (!section.classList.contains('collapsed')) {
                        contentWrapper.style.height = content.offsetHeight + 'px';
                    }
                });
                
                resizeObserver.observe(content);
            }
        });
    });
</script>

<!-- Функции поиска -->
<script>
    // Функция инициализации поиска
    function initializeSearch() {
        const searchInput = document.getElementById('itemSearch');
        const suggestionsContainer = document.getElementById('searchSuggestions');
        const clearButton = document.getElementById('clearSearch');
        let searchDebounceTimer;
    
        if (!searchInput || !suggestionsContainer || !clearButton) return;
    
        // Обработчик ввода в поисковое поле
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.trim().toLowerCase();
            clearTimeout(searchDebounceTimer);
    
            if (searchTerm === '') {
                suggestionsContainer.style.display = 'none';
                applyFilters(window.data, 1);
                return;
            }
    
            searchDebounceTimer = setTimeout(() => {
                const suggestions = findSuggestions(searchTerm);
                displaySuggestions(suggestions, searchTerm);
                applyFilters(window.data, 1);
            }, 300);
        });
    
        // Обработчик клика по кнопке очистки
        clearButton.addEventListener('click', () => {
            searchInput.value = '';
            suggestionsContainer.style.display = 'none';
            applyFilters(window.data, 1);
        });
    
        // Скрытие подсказок при клике вне поиска
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-container')) {
                suggestionsContainer.style.display = 'none';
            }
        });
    }
    
    // Поиск подходящих предметов
    function findSuggestions(searchTerm) {
        if (!window.data || !window.data.items) return [];
    
        return window.data.items
            .filter(item => {
                const matchesId = item.IID.toString().toLowerCase().includes(searchTerm);
                const matchesName = item.IName.toLowerCase().includes(searchTerm);
                return matchesId || matchesName;
            })
            .slice(0, 8); // Ограничиваем количество подсказок
    }
    
    // Отображение подсказок
    function displaySuggestions(suggestions, searchTerm) {
        const suggestionsContainer = document.getElementById('searchSuggestions');
        if (!suggestionsContainer) return;
    
        if (!suggestions.length) {
            suggestionsContainer.style.display = 'none';
            return;
        }
    
        const suggestionsHtml = suggestions.map(item => {
            const itemName = highlightMatch(item.IName, searchTerm);
            const itemId = highlightMatch(item.IID.toString(), searchTerm);
            const imageUrl = window.data.resources[item.IID] || 'https://raw.githubusercontent.com/Aksel911/R2-HTML-DB/main/static/no_monster/no_monster_image.png';
            const fallbackImage = 'https://raw.githubusercontent.com/Aksel911/R2-HTML-DB/main/static/no_monster/no_monster_image.png';
            
            return `
                <a href="/item/${item.IID}" class="search-suggestion" data-id="${item.IID}">
                    <img src="${imageUrl}" alt="${item.IName} onerror="this.onerror=null; this.src='${fallbackImage}';">
                    <span>[${itemId}] ${itemName}</span>
                </a>
            `;
        }).join('');
    
        suggestionsContainer.innerHTML = suggestionsHtml;
        suggestionsContainer.style.display = 'block';
    }
    
    // Подсветка совпадений
    function highlightMatch(text, searchTerm) {
        if (!searchTerm) return text;
        const escapedSearchTerm = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const regex = new RegExp(`(${escapedSearchTerm})`, 'gi');
        return text.replace(regex, '<span class="highlight">$1</span>');
    }
    
    // Модифицируем существующую функцию applyFilters для поддержки поиска
    const originalApplyFilters = window.applyFilters;
    window.applyFilters = function(data, page = 1) {
        const searchTerm = document.getElementById('itemSearch')?.value.trim().toLowerCase();
        
        // Применяем поисковый фильтр перед остальными фильтрами
        let filteredData = {...data};
        if (searchTerm) {
            filteredData.items = data.items.filter(item => {
                const matchesId = item.IID.toString().toLowerCase().includes(searchTerm);
                const matchesName = item.IName.toLowerCase().includes(searchTerm);
                return matchesId || matchesName;
            });
        }
        
        // Вызываем оригинальную функцию фильтрации с отфильтрованными данными
        originalApplyFilters(filteredData, page);
    }
    
    // Добавляем инициализацию поиска в существующую функцию initialize
    const originalInitialize = window.initialize;
    window.initialize = async function() {
        await originalInitialize();
        initializeSearch();
    }
</script>



<!-- Функции поиска -->
<script>
    // Функция инициализации поиска
    function initializeSearch() {
        const searchInput = document.getElementById('itemSearch');
        const suggestionsContainer = document.getElementById('searchSuggestions');
        const clearButton = document.getElementById('clearSearch');
        let searchDebounceTimer;
    
        if (!searchInput || !suggestionsContainer || !clearButton) {
            console.error('Search elements not found:', {
                searchInput: !!searchInput,
                suggestionsContainer: !!suggestionsContainer,
                clearButton: !!clearButton
            });
            return;
        }
    
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.trim().toLowerCase();
            clearTimeout(searchDebounceTimer);
    
            if (searchTerm === '') {
                suggestionsContainer.style.display = 'none';
                app.applyFilters(1);
                return;
            }
    
            searchDebounceTimer = setTimeout(() => {
                const suggestions = findSuggestions(searchTerm);
                displaySuggestions(suggestions, searchTerm);
                app.applyFilters(1); // Применяем фильтры после обновления строки поиска
            }, 300);
        });
    
        clearButton.addEventListener('click', () => {
            searchInput.value = '';
            suggestionsContainer.style.display = 'none';
            app.applyFilters(1);
        });
    
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-container')) {
                suggestionsContainer.style.display = 'none';
            }
        });
    }
    
    // Поиск подходящих предметов
    function findSuggestions(searchTerm) {
        const cachedData = app?.stateManager?.getState('cachedData');
        if (!cachedData?.items) {
            console.log('No cached data available for suggestions');
            return [];
        }
    
        return cachedData.items
            .filter(item => {
                const matchesId = item.IID.toString().toLowerCase().includes(searchTerm);
                const matchesName = item.IName.toLowerCase().includes(searchTerm);
                return matchesId || matchesName;
            })
            .slice(0, 8);
    }
    
    // Отображение подсказок
    function displaySuggestions(suggestions, searchTerm) {
        const suggestionsContainer = document.getElementById('searchSuggestions');
        if (!suggestionsContainer) return;
    
        if (!suggestions.length) {
            suggestionsContainer.style.display = 'none';
            return;
        }
    
        const resources = app?.stateManager?.getState('cachedData')?.resources || {};
        
        const suggestionsHtml = suggestions.map(item => {
            const itemName = highlightMatch(item.IName, searchTerm);
            const itemId = highlightMatch(item.IID.toString(), searchTerm);
            const imageUrl = resources[item.IID] || CONSTANTS.FALLBACK_IMAGE;
            
            return `
                <a href="/item/${item.IID}" class="search-suggestion" data-id="${item.IID}">
                    <img src="${imageUrl}" alt="${item.IName}" onerror="this.src='${CONSTANTS.FALLBACK_IMAGE}';">
                    <span>[${itemId}] ${itemName}</span>
                </a>
            `;
        }).join('');
    
        suggestionsContainer.innerHTML = suggestionsHtml;
        suggestionsContainer.style.display = 'block';
    }
    
    // Подсветка совпадений
    function highlightMatch(text, searchTerm) {
        if (!searchTerm) return text;
        const escapedSearchTerm = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const regex = new RegExp(`(${escapedSearchTerm})`, 'gi');
        return text.replace(regex, '<span class="highlight">$1</span>');
    }
    
    // FilterManager с поддержкой поиска
    FilterManager.filterData = function(items, filters) {
        const searchTerm = document.getElementById('itemSearch')?.value.trim().toLowerCase();
    
        // Применяем поисковый фильтр перед остальными фильтрами
        let filteredData = items;
        if (searchTerm) {
            filteredData = items.filter(item => {
                const matchesId = item.IID.toString().toLowerCase().includes(searchTerm);
                const matchesName = item.IName.toLowerCase().includes(searchTerm);
                return matchesId || matchesName;
            });
        }
    
        // Применяем остальные фильтры
        return filteredData.filter(item => 
            FilterManager._applyAllFilters(item, filters));
    }
</script>


<!-- Звук при клике     /-> курсоры
<script>
    /* JavaScript для воспроизведения звука при клике */
const clickSound = new Audio('sounds/gui_click.wav');

// Добавляем обработчик для всех элементов с классом .click-sound
document.querySelectorAll('.click-sound').forEach(element => {
    element.addEventListener('click', () => {
        clickSound.currentTime = 0; // Сбрасываем время воспроизведения
        clickSound.play();
    });
});

</script>

-->
<!-- Filters container -->
<div class="filters-container mb-4">
    <div class="row">

        <!-- –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã -->
        <div class="col-md-12">
            <button class="btn btn-primary mb-3" type="button" data-toggle="collapse" data-target="#mainFilters">
                <i class="fas fa-filter"></i> –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
            </button>
            <button class="btn btn-secondary mb-3 ml-2" type="button" data-toggle="collapse" data-target="#advancedFilters">
                <i class="fas fa-sliders-h"></i> –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
            </button>
            <button class="btn btn-info mb-3 ml-2" id="resetFilters">
                <i class="fas fa-sync"></i> –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
            </button>
            <button class="theme-toggle" id="theme-toggle">
                <i class="fas fa-moon"></i>
            </button>
            <select id="perPageSelect" class="form-control same-width-as-reset"></select>
        </div>

        <!-- –ü–æ–∏—Å–∫ -->
        <div class="col-md-12 mb-3">
            <div class="search-container position-relative">
                <div class="input-group">
                    <input type="text" 
                        class="form-control" 
                        id="itemSearch" 
                        placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ ID –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—é –ø—Ä–µ–¥–º–µ—Ç–∞..."
                        autocomplete="off">
                    <div class="input-group-append">
                        <button class="btn btn-outline-secondary" type="button" id="clearSearch">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div id="searchSuggestions" class="position-absolute w-100 bg-white border rounded-bottom shadow-sm" 
                    style="display: none; z-index: 1000; max-height: 300px; overflow-y: auto;"></div>
            </div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã -->
        <div class="col-12 collapse" id="mainFilters">
            <div class="card card-body mb-3 filter-card-container">
                <div class="filterrow">
                    <!-- –¢–∏–ø –ø—Ä–µ–¥–º–µ—Ç–∞ -->
                    <div class="filter-group">
                        <label for="typeFilter"><i class="fas fa-dragon me-2"></i> –¢–∏–ø –ø—Ä–µ–¥–º–µ—Ç–∞:</label>
                        <select class="form-control" id="typeFilter">
                            <option value="">–í—Å–µ</option>
                        </select>
                    </div>
            
                    <!-- –£—Ä–æ–≤–µ–Ω—å -->
                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="fas fa-layer-group me-2"></i>–£—Ä–æ–≤–µ–Ω—å –ø—Ä–µ–¥–º–µ—Ç–∞
                        </label>
                        <div class="input-group filter-range">
                            <input type="number" class="form-control" id="levelMin" placeholder="–ú–∏–Ω">
                            <span class="input-group-text range-separator">
                                <i class="fas fa-arrows-alt-h"></i>
                            </span>
                            <input type="number" class="form-control" id="levelMax" placeholder="–ú–∞–∫—Å">
                        </div>
                    </div>
            
                    <!-- –í–µ—Å -->
                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="fas fa-weight-hanging me-2"></i>–í–µ—Å –ø—Ä–µ–¥–º–µ—Ç–∞
                        </label>
                        <div class="input-group filter-range">
                            <input type="number" class="form-control" id="weightMin" placeholder="–ú–∏–Ω">
                            <span class="input-group-text range-separator">
                                <i class="fas fa-arrows-alt-h"></i>
                            </span>
                            <input type="number" class="form-control" id="weightMax" placeholder="–ú–∞–∫—Å">
                        </div>
                    </div>
            
                    <!-- –°—Ç–∞–∫–∞–µ—Ç—Å—è -->
                    <div class="filter-group">
                        <label class="filter-label" for="stackableFilter">
                            <i class="fas fa-layer-group me-2"></i>–°—Ç–∞–∫–∞–µ—Ç—Å—è
                        </label>
                        <select class="form-control" id="stackableFilter">
                            <option value="">–í—Å–µ</option>
                            <option value="1">–î–∞</option>
                            <option value="0">–ù–µ—Ç</option>
                        </select>
                    </div>
            
                    <!-- –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è (–¥–Ω–∏) -->
                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="fas fa-calendar-day me-2"></i>–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è (–¥–Ω–∏)
                        </label>
                        <div class="input-group filter-range">
                            <input type="number" class="form-control" id="validityDaysMin" placeholder="–ú–∏–Ω">
                            <span class="input-group-text range-separator">
                                <i class="fas fa-arrows-alt-h"></i>
                            </span>
                            <input type="number" class="form-control" id="validityDaysMax" placeholder="–ú–∞–∫—Å">
                        </div>
                    </div>
            
                    <!-- –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è (–º–∏–Ω—É—Ç—ã) -->
                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="fas fa-clock me-2"></i>–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è (–º–∏–Ω—É—Ç—ã)
                        </label>
                        <div class="input-group filter-range">
                            <input type="number" class="form-control" id="validityMinutesMin" placeholder="–ú–∏–Ω">
                            <span class="input-group-text range-separator">
                                <i class="fas fa-arrows-alt-h"></i>
                            </span>
                            <input type="number" class="form-control" id="validityMinutesMax" placeholder="–ú–∞–∫—Å">
                        </div>
                    </div>
            
                    <!-- –ù–æ–º–µ—Ä –∫–≤–µ—Å—Ç–∞ -->
                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="fas fa-scroll me-2"></i>–ù–æ–º–µ—Ä –∫–≤–µ—Å—Ç–∞
                        </label>
                        <input type="number" class="form-control" id="questNoFilter" placeholder="–ù–æ–º–µ—Ä –∫–≤–µ—Å—Ç–∞">
                    </div>
                </div>
            </div>
            
        </div>

        <!-- –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã -->
        <div class="col-12 collapse" id="advancedFilters">
            <div class="card card-body">
                <div class="row">
                    <div class="col-12">
                        <div class="advanced-filters-grid">
                            <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è –≤—Å–µ—Ö –∫–æ–ª–æ–Ω–æ–∫ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="totalCount" class="mb-3 mt-3">–ù–∞–π–¥–µ–Ω–æ –ø—Ä–µ–¥–º–µ—Ç–æ–≤: 0</div>
<div class="pagination-container mb-4 d-flex justify-content-center gap-2"></div>

<!-- Loading overlay and messages -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="loading-content">
        <div class="spinner"></div>
        <span>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</span>
    </div>
</div>
<div id="errorMessage" class="message-container error-message"></div>



<!-- –ì–õ–ê–í–ù–´–ï –°–ö–†–ò–ü–¢–´ –§–ò–õ–¨–¢–†–ê -->
<script>

    // Constants and Configuration
    const CONSTANTS = {
        DEBOUNCE_DELAY: 300,
        DEFAULT_PER_PAGE: 25,
        LOADING_FADE_DELAY: 500,
        ERROR_DISPLAY_TIME: 5000,
        PAGINATION_RADIUS: 2,
        FALLBACK_IMAGE: 'https://raw.githubusercontent.com/Aksel911/R2-HTML-DB/main/static/no_monster/no_monster_image.png',
        TABLE_FADE_DURATION: 300,
        BUTTON_ANIMATION_DURATION: 200,
        ANIMATION_CLASSES: {
            FADE_ENTER: 'table-fade-enter',
            FADE_ENTER_ACTIVE: 'table-fade-enter-active'
        },
        PER_PAGE_OPTIONS: [10, 25, 50, 75, 100, 150, 200]
    };
    
    const TYPE_MAPPINGS = {
        '/weapon': [1, 18, 20],
        '/armor': [3],
        '/gloves': [7],
        '/boots': [6],
        '/helmet': [8],
        '/shield': [2],
        '/arrows': [19],
        '/cloak': [17],
        '/materials': [10, 16],
        '/ring': [4],
        '/belt': [9],
        '/necklace': [5],
        '/earrings': [42],
        '/books': [12],
        '/potions': [10],
        '/etc': [14, 16, 13, 11],
        '/sphere': [22, 23, 24, 25, 26, 27, 28, 29],
        '/quest': [15, 16]
    };
    
    const TYPE_DESCRIPTIONS = {
        1: '–û—Ä—É–∂–∏–µ –ë–ª–∏–∂–Ω–µ–≥–æ –ë–æ—è',
        2: '–©–∏—Ç, –ë—Ä–∞—Å–ª–µ—Ç',
        3: '–î–æ—Å–ø–µ—Ö',
        4: '–ö–æ–ª—å—Ü–æ',
        5: '–û–∂–µ—Ä–µ–ª—å–µ',
        6: '–ë–æ—Ç–∏–Ω–∫–∏',
        7: '–ü–µ—Ä—á–∞—Ç–∫–∏',
        8: '–®–ª–µ–º',
        9: '–†–µ–º–µ–Ω—å',
        10: '–ó–µ–ª—å—è',
        11: 'SpecificProcItem/Shop Item',
        12: '–ö–Ω–∏–≥–∞',
        13: '–ñ–µ–∑–ª, –§–µ–π–µ—Ä–≤–µ—Ä–∫, –ü–µ—Ç–∞—Ä–¥–∞',
        14: '–ü—Ä–µ–¥–º–µ—Ç —Å–æ Skill',
        15: '–°—É–Ω–¥—É–∫',
        16: '–ü—É—Å—Ç—ã—à–∫–∞, –ü–µ—á–∞—Ç–∏, –ö–≤–µ—Å—Ç–æ–≤—ã–π',
        17: '–ü–ª–∞—â',
        18: '–û—Ä—É–∂–∏–µ –î–∞–ª—å–Ω–µ–≥–æ –ë–æ—è',
        19: '–ü–∞—Ç—Ä–æ–Ω—ã, —Å—Ç—Ä–µ–ª—ã, –∫–∞–º–Ω–∏',
        20: '–ê–ª–µ–±–∞—Ä–¥–∞/–ö–æ–ø—å–µ',
        22: '–°—Ñ–µ—Ä–∞ –ú–∞—Å—Ç–µ—Ä–∞',
        23: '–°—Ñ–µ—Ä–∞ –î—É—à–∏',
        24: '–°—Ñ–µ—Ä–∞ –ó–∞—â–∏—Ç—ã',
        25: '–°—Ñ–µ—Ä–∞ –†–∞–∑—Ä—É—à–µ–Ω–∏—è',
        26: '–°—Ñ–µ—Ä–∞ –ñ–∏–∑–Ω–∏',
        27: '–°—Ñ–µ—Ä–∞ 1 –°–ª–æ—Ç',
        28: '–°—Ñ–µ—Ä–∞ 2 –°–ª–æ—Ç',
        29: '–°—Ñ–µ—Ä–∞ 3 –°–ª–æ—Ç',
        42: '–°–µ—Ä—å–≥–∏'
    };
    
    const ADVANCED_FILTERS = [
        { id: 'IDHIT', label: '–¢–æ—á–Ω–æ—Å—Ç—å –≤ –±–ª–∏–∂–Ω–µ–º –±–æ—é', icon: 'üéØ' },
        { id: 'IDDD', label: '–£—Ä–æ–Ω –≤ –±–ª–∏–∂–Ω–µ–º –±–æ—é', icon: '‚öîÔ∏è' },
        { id: 'IRHIT', label: '–¢–æ—á–Ω–æ—Å—Ç—å –≤ –¥–∞–ª—å–Ω–µ–º –±–æ—é', icon: 'üèπ' },
        { id: 'IRDD', label: '–£—Ä–æ–Ω –≤ –¥–∞–ª—å–Ω–µ–º –±–æ—é', icon: 'üéØ' },
        { id: 'IMHIT', label: '–ú–∞–≥–∏—á–µ—Å–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å', icon: '‚ú®' },
        { id: 'IMDD', label: '–ú–∞–≥–∏—á–µ—Å–∫–∏–π —É—Ä–æ–Ω', icon: 'üîÆ' },
        { id: 'IHPPlus', label: '–î–æ–ø. HP', icon: '‚ù§Ô∏è' },
        { id: 'IMPPlus', label: '–î–æ–ø. MP', icon: 'üíß' },
        { id: 'ISTR', label: '–°–∏–ª–∞', icon: 'üí™' },
        { id: 'IDEX', label: '–õ–æ–≤–∫–æ—Å—Ç—å', icon: 'üèÉ' },
        { id: 'IINT', label: '–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç', icon: 'üß†' },
        { id: 'IHPRegen', label: '–†–µ–≥–µ–Ω HP', icon: '‚ô•Ô∏è' },
        { id: 'IMPRegen', label: '–†–µ–≥–µ–Ω MP', icon: 'üí´' },
        { id: 'IAttackRate', label: '–°–∫–æ—Ä–æ—Å—Ç—å –∞—Ç–∞–∫–∏', icon: '‚ö°' },
        { id: 'IMoveRate', label: '–°–∫–æ—Ä–æ—Å—Ç—å –ø–µ—Ä–µ–¥–≤–∏–∂–µ–Ω–∏—è', icon: 'üèÉ' },
        { id: 'ICritical', label: '–®–∞–Ω—Å –∫—Ä–∏—Ç–∞', icon: 'üéØ' }
    ];
    
    // Utilities
    class EventEmitter {
        constructor() {
            this.events = {};
        }
    
        on(event, callback) {
            if (!this.events[event]) {
                this.events[event] = [];
            }
            this.events[event].push(callback);
            return () => this.off(event, callback);
        }
    
        off(event, callback) {
            if (!this.events[event]) return;
            this.events[event] = this.events[event].filter(cb => cb !== callback);
        }
    
        emit(event, data) {
            if (!this.events[event]) return;
            this.events[event].forEach(callback => callback(data));
        }
    }
    
    // State Management
    class StateManager extends EventEmitter {
        constructor() {
            super();
            this._state = {
                currentPage: 1,
                cachedData: null,
                debounceTimer: null,
                isLoading: false,
                error: null,
                filters: {},
                perPage: CONSTANTS.DEFAULT_PER_PAGE
            };
        }
    
        setState(key, value) {
            const oldValue = this._state[key];
            this._state[key] = value;
            
            if (oldValue !== value) {
                this.emit('stateChange', { key, value, oldValue });
            }
        }
    
        getState(key) {
            return this._state[key];
        }
    
        resetState() {
            Object.keys(this._state).forEach(key => {
                if (key !== 'cachedData') {
                    this.setState(key, null);
                }
            });
        }
    }
    
    // Data Service
    class ItemDataService {
        constructor(stateManager) {
            this.stateManager = stateManager;
        }
    
        async fetchData(forceReload = false) {
            if (this.stateManager.getState('cachedData') && !forceReload) {
                return this.stateManager.getState('cachedData');
            }
    
            this.stateManager.setState('isLoading', true);
    
            try {
                const data = await this._fetchAllPages();
                this.stateManager.setState('cachedData', data);
                return data;
            } catch (error) {
                this.stateManager.setState('error', error.message);
                return null;
            } finally {
                this.stateManager.setState('isLoading', false);
            }
        }
    
        async _fetchAllPages() {
            const firstPageResponse = await this._fetchPage(1);
            let allItems = [...firstPageResponse.items];
            
            const totalPages = firstPageResponse.pages;
            const remainingPages = Array.from(
                { length: totalPages - 1 }, 
                (_, i) => i + 2
            );
            
            const pageResponses = await Promise.all(
                remainingPages.map(page => this._fetchPage(page))
            );
    
            pageResponses.forEach(response => {
                if (response.items) {
                    allItems = allItems.concat(response.items);
                }
            });
    
            return { ...firstPageResponse, items: allItems };
        }
    
        async _fetchPage(page) {
            const response = await fetch(
                `${window.location.pathname}?all=1&page=${page}`,
                { headers: { 'X-Requested-With': 'XMLHttpRequest' } }
            );
    
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
    
            const data = await response.json();
            if (data.error) {
                throw new Error(data.error);
            }
    
            return data;
        }
    }
    
    // Filter Logic
    class ItemFilterManager {
        static collectFilters() {
            const filters = {};
            document.querySelectorAll('.form-control, .custom-control-input')
                .forEach(input => {
                    if (input.id === 'perPageSelect' || input.id === 'itemSearch') return;
                    
                    const value = input.type === 'checkbox' ? input.checked : input.value;
                    if ((input.type === 'checkbox' && value) || 
                        (input.type !== 'checkbox' && value)) {
                        filters[input.id] = input.type === 'checkbox' ? '1' : value;
                    }
                });
            return filters;
        }
    
        static filterData(items, filters) {
            // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–∏—Å–∫
            const searchTerm = document.getElementById('itemSearch')?.value.trim().toLowerCase();
            let filteredData = items;
    
            if (searchTerm) {
                filteredData = items.filter(item => {
                    const matchesId = item.IID.toString().toLowerCase().includes(searchTerm);
                    const matchesName = item.IName.toLowerCase().includes(searchTerm);
                    return matchesId || matchesName;
                });
            }
    
            // –ó–∞—Ç–µ–º –ø—Ä–∏–º–µ–Ω—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
            return filteredData.filter(item => this._applyAllFilters(item, filters));
        }
    
        static _applyAllFilters(item, filters) {
            return Object.entries(filters).every(([key, value]) => {
                // –ë–∞–∑–æ–≤—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
                if (key === 'typeFilter') {
                    return item.IType === Number(value);
                }
                
                // –§–∏–ª—å—Ç—Ä—ã –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤
                if (key.endsWith('Min') || key.endsWith('Max')) {
                    return this._applyRangeFilter(item, key, value);
                }
    
                // –ë—É–ª–µ–≤—ã —Ñ–∏–ª—å—Ç—Ä—ã
                if (this._isBooleanFilter(key)) {
                    return this._applyBooleanFilter(item, key);
                }
    
                return true;
            });
        }
    
        static _applyRangeFilter(item, key, value) {
            const baseKey = key.replace(/(Min|Max)$/, '');
            const isMin = key.endsWith('Min');
            const itemValue = this._getItemValue(item, baseKey);
            const filterValue = Number(value);
    
            return isMin ? 
                itemValue >= filterValue : 
                itemValue <= filterValue;
        }
    
        static _isBooleanFilter(key) {
            return [
                'eventItemFilter',
                'testItemFilter',
                'indictFilter',
                'chargeFilter',
                'partyDropFilter'
            ].includes(key);
        }
    
        static _applyBooleanFilter(item, key) {
            const mappings = {
                eventItemFilter: 'IIsEvent',
                testItemFilter: 'IIsTest',
                indictFilter: 'IIsIndict',
                chargeFilter: 'IIsCharge',
                partyDropFilter: 'IIsPartyDrop'
            };
            
            return item[mappings[key]] === true;
        }
    
        static _getItemValue(item, baseKey) {
            const mappings = {
                level: 'ILevel',
                weight: 'IWeight',
                validityDays: 'ITermOfValidity',
                validityMinutes: 'ITermOfValidityMi'
            };
    
            return item[mappings[baseKey] || baseKey] || 0;
        }
    }
    
    // UI Management
    class ItemUIManager {
        constructor(stateManager) {
            this.stateManager = stateManager;
            this.setupStateSubscriptions();
            this.setupAnimations();
        }
    
        setupStateSubscriptions() {
            this.stateManager.on('stateChange', ({key, value}) => {
                switch(key) {
                    case 'isLoading':
                        this.toggleLoadingState(value);
                        break;
                    case 'error':
                        if (value) this.showError(value);
                        break;
                }
            });
        }
    
        setupAnimations() {
            this.setupTableAnimations();
            this.setupPaginationAnimations();
        }
    
        setupTableAnimations() {
            const style = document.createElement('style');
            style.textContent = `
                .table-fade-enter {
                    opacity: 0;
                    transform: translateY(-10px);
                }
                .table-fade-enter-active {
                    opacity: 1;
                    transform: translateY(0);
                    transition: opacity 300ms ease-in-out, transform 300ms ease-out;
                }
                .pagination-fade {
                    transition: opacity 200ms ease-in-out;
                }
                .pagination-button-active {
                    transform: scale(0.95);
                    transition: transform 200ms ease-out;
                }
            `;
            document.head.appendChild(style);
        }
    
        setupPaginationAnimations() {
            document.addEventListener('click', e => {
                if (e.target.matches('.pagination-container button')) {
                    e.target.classList.add('pagination-button-active');
                    setTimeout(() => {
                        e.target.classList.remove('pagination-button-active');
                    }, CONSTANTS.BUTTON_ANIMATION_DURATION);
                }
            });
        }
    
        initializeUI() {
            this.initializeFilters();
            this.setupEventListeners();
        }
    
        initializeFilters() {
            this.initializeTypeFilter();
            this.initializeAdvancedFilters();
            this.initializePerPageSelect();
        }
    
        initializeTypeFilter() {
            const typeFilter = document.getElementById('typeFilter');
            if (!typeFilter) return;
    
            const allowedTypes = this._getAllowedTypes();
            
            typeFilter.innerHTML = this._createTypeFilterOptions(allowedTypes);
        }
    
        _getAllowedTypes() {
            return TYPE_MAPPINGS[window.location.pathname] || 
                   Object.keys(TYPE_DESCRIPTIONS);
        }
    
        _createTypeFilterOptions(types) {
            const options = ['<option value="">–í—Å–µ</option>'];
            
            types.forEach(type => {
                options.push(`
                    <option value="${type}">
                        ${TYPE_DESCRIPTIONS[type] || `–¢–∏–ø ${type}`}
                    </option>
                `);
            });
            
            return options.join('');
        }
    
        initializeAdvancedFilters() {
            const container = document.querySelector('.advanced-filters-grid');
            if (!container) return;
    
            container.innerHTML = ADVANCED_FILTERS
                .map(this._createFilterCard)
                .join('');
        }
    
        _createFilterCard(filter) {
            return `
                <div class="filter-card" data-filter="${filter.id}">
                    <div class="filter-card-header">
                        <span class="filter-icon">${filter.icon}</span>
                        <span class="filter-label">${filter.label}</span>
                    </div>
                    <div class="filter-inputs">
                        <div class="input-group">
                            <input type="number" 
                                   class="form-control" 
                                   id="${filter.id}Min" 
                                   placeholder="–ú–∏–Ω" 
                                   step="any">
                            <div class="input-group-text">-</div>
                            <input type="number" 
                                   class="form-control" 
                                   id="${filter.id}Max" 
                                   placeholder="–ú–∞–∫—Å" 
                                   step="any">
                        </div>
                    </div>
                </div>
            `;
        }
    
        initializePerPageSelect() {
            const perPageSelect = document.getElementById('perPageSelect');
            if (!perPageSelect) return;
    
            perPageSelect.innerHTML = CONSTANTS.PER_PAGE_OPTIONS
                .map(n => `<option value="${n}">${n} –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ</option>`)
                .join('');
            
            perPageSelect.value = this.stateManager.getState('perPage').toString();
        }
    
        setupEventListeners() {
            this._setupFilterContainerListener();
            this._setupResetButton();
            this._setupPerPageSelect();
        }
    
        _setupFilterContainerListener() {
            const container = document.querySelector('.filters-container');
            if (!container) return;
    
            container.addEventListener('input', event => {
                if (this._isFilterInput(event.target)) {
                    this._handleFilterInput();
                }
            });
        }
    
        _isFilterInput(element) {
            return element.classList.contains('form-control') || 
                   element.classList.contains('custom-control-input');
        }
    
        _handleFilterInput() {
            clearTimeout(this.stateManager.getState('debounceTimer'));
            
            const timer = setTimeout(
                () => this._triggerFiltersUpdate(),
                CONSTANTS.DEBOUNCE_DELAY
            );
            
            this.stateManager.setState('debounceTimer', timer);
        }
    
        _setupResetButton() {
            const resetButton = document.getElementById('resetFilters');
            if (!resetButton) return;
    
            resetButton.addEventListener('click', () => {
                this._resetAllFilters();
                this._triggerFiltersUpdate();
            });
        }
    
        _resetAllFilters() {
            document.querySelectorAll('.form-control, .custom-control-input')
                .forEach(input => {
                    if (input.id === 'perPageSelect') return;
                    
                    if (input.type === 'checkbox') {
                        input.checked = false;
                    } else {
                        input.value = '';
                    }
                });
        }
    
        _setupPerPageSelect() {
            const perPageSelect = document.getElementById('perPageSelect');
            if (!perPageSelect) return;
    
            perPageSelect.addEventListener('change', () => {
                this.stateManager.setState('currentPage', 1);
                this.stateManager.setState('perPage', 
                    Number(perPageSelect.value));
                this._triggerFiltersUpdate();
            });
        }
    
        _triggerFiltersUpdate() {
            document.dispatchEvent(new CustomEvent('filtersUpdated'));
        }
    
        renderItems(items, resources) {
            const tableBody = document.querySelector('table tbody');
            if (!tableBody) return;
    
            this._animateTableUpdate(tableBody, () => {
                tableBody.innerHTML = this._generateItemsHTML(items, resources);
            });
        }
    
        _animateTableUpdate(tableBody, updateFn) {
            tableBody.classList.add(CONSTANTS.ANIMATION_CLASSES.FADE_ENTER);
            
            requestAnimationFrame(() => {
                updateFn();
                
                tableBody.classList.remove(CONSTANTS.ANIMATION_CLASSES.FADE_ENTER);
                tableBody.classList.add(CONSTANTS.ANIMATION_CLASSES.FADE_ENTER_ACTIVE);
                
                setTimeout(() => {
                    tableBody.classList.remove(
                        CONSTANTS.ANIMATION_CLASSES.FADE_ENTER_ACTIVE
                    );
                }, CONSTANTS.TABLE_FADE_DURATION);
            });
        }
    
        _generateItemsHTML(items, resources) {
            const tableHeaders = this._generateTableHeaders();
            const itemsRows = items.map(item => 
                this._generateItemRow(item, resources)
            ).join('');
    
            return tableHeaders + itemsRows;
        }
    
        _generateTableHeaders() {
            return `
                {% block table_headers %}
                    <th>üñºÔ∏è</th>
                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                    <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                    <th>–í–µ—Å</th>
                    <th>–ö–ª–∞—Å—Å</th>
                {% endblock %}
            `;
        }
    
        _generateItemRow(item, resources) {
            return `
                <tr>
                    <td>
                        <div class="hover-text-wrapper">
                            <a href="/item/${item.IID}">
                                <img src="${resources[item.IID] || CONSTANTS.FALLBACK_IMAGE}"
                                    alt="${item.IName}"
                                    title="${item.IName}"
                                    width="48"
                                    height="48"
                                    loading="lazy"
                                    class="item-image"
                                    onerror="this.src='${CONSTANTS.FALLBACK_IMAGE}';">
                            </a>
                            <div class="hover-text">[${item.IID}] ${item.IName}</div>
                        </div>
                    </td>
                    <td>
                        <div class="item-name">
                            <a href="/item/${item.IID}">${item.IName}</a>
                        </div>
                    </td>
                    <td class="item-desc">${item.IDesc || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}</td>
                    <td>${item.IWeight || 'N/A'}</td>
                    <td><img src="${item.IUseClass || 'N/A'}" alt="${item.IName}"></td>
                </tr>
            `;
        }
    
        createPagination(total, currentPage, perPage) {
            const paginationContainer = document.querySelector('.pagination-container');
            if (!paginationContainer) return;
    
            const totalPages = Math.ceil(total / perPage);
            
            paginationContainer.style.opacity = '0';
            paginationContainer.innerHTML = this._generatePaginationHTML(
                totalPages, currentPage
            );
            
            requestAnimationFrame(() => {
                paginationContainer.style.opacity = '1';
            });
        }
    
        _generatePaginationHTML(totalPages, currentPage) {
            const buttons = [];
    
            // Previous button
            buttons.push(this._createPaginationButton(
                '–ü—Ä–µ–¥—ã–¥—É—â–∞—è',
                currentPage - 1,
                currentPage === 1
            ));
    
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (this._shouldShowPageNumber(i, currentPage, totalPages)) {
                    buttons.push(this._createPaginationButton(
                        i.toString(),
                        i,
                        false,
                        i === currentPage
                    ));
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    buttons.push('<span class="pagination-ellipsis">...</span>');
                }
            }
    
            // Next button
            buttons.push(this._createPaginationButton(
                '–°–ª–µ–¥—É—é—â–∞—è',
                currentPage + 1,
                currentPage === totalPages
            ));
    
            return buttons.join('');
        }
    
        _shouldShowPageNumber(pageNum, currentPage, totalPages) {
            return pageNum === 1 || 
                   pageNum === totalPages || 
                   (pageNum >= currentPage - CONSTANTS.PAGINATION_RADIUS && 
                    pageNum <= currentPage + CONSTANTS.PAGINATION_RADIUS);
        }
    
        _createPaginationButton(text, pageNum, isDisabled, isActive = false) {
            const className = isActive ? 'btn-primary' : 'btn-secondary';
            const disabled = isDisabled ? 'disabled' : '';
            return `
                <button class="btn ${className} ${disabled}"
                        onclick="app.applyFilters(${pageNum})"
                        ${disabled}>
                    ${text}
                </button>
            `;
        }
    
        updateTotalCount(count) {
            const totalCount = document.getElementById('totalCount');
            if (totalCount) {
                totalCount.textContent = `–ù–∞–π–¥–µ–Ω–æ –ø—Ä–µ–¥–º–µ—Ç–æ–≤: ${count}`;
            }
        }
    
        updateURL(params) {
            const url = new URL(window.location.href);
            url.search = new URLSearchParams(params).toString();
            history.pushState({}, '', url);
        }
    
        toggleLoadingState(isLoading) {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (!loadingOverlay) return;
    
            if (isLoading) {
                loadingOverlay.classList.add('show');
            } else {
                setTimeout(() => {
                    loadingOverlay.classList.remove('show');
                }, CONSTANTS.LOADING_FADE_DELAY);
            }
        }
    
        showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            if (!errorMessage) return;
    
            errorMessage.textContent = `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ${message}`;
            errorMessage.classList.add('show');
    
            setTimeout(() => {
                errorMessage.classList.remove('show');
            }, CONSTANTS.ERROR_DISPLAY_TIME);
        }
    }
    
    // Main Application Class
    class ItemFilterApp {
        constructor() {
            this.stateManager = new StateManager();
            this.dataService = new ItemDataService(this.stateManager);
            this.uiManager = new ItemUIManager(this.stateManager);
        }
    
        async initialize() {
            await this.dataService.fetchData();
            this.uiManager.initializeUI();
            this.setupEventListeners();
            this.applyFilters(1);
            initializeSearch(); 
        }
    
        setupEventListeners() {
            document.addEventListener('filtersUpdated', () => {
                this.applyFilters(1);
            });
        }
    
        async applyFilters(page = 1) {
            const cachedData = this.stateManager.getState('cachedData');
            if (!cachedData) return;
    
            const filters = ItemFilterManager.collectFilters();
            const filteredData = ItemFilterManager.filterData(cachedData.items, filters);
            
            const perPage = this.stateManager.getState('perPage');
            const paginatedData = this._paginateData(filteredData, page, perPage);
            
            this.stateManager.setState('currentPage', page);
            this.uiManager.updateTotalCount(filteredData.length);
            this.uiManager.renderItems(paginatedData, cachedData.resources);
            this.uiManager.createPagination(filteredData.length, page, perPage);
            this.uiManager.updateURL(filters);
        }
    
        _paginateData(data, page, perPage) {
            const start = (page - 1) * perPage;
            return data.slice(start, start + perPage);
        }
    }
    
    // Initialize application
    let app;
    document.addEventListener('DOMContentLoaded', () => {
        app = new ItemFilterApp();
        app.initialize();
    });
    
</script>
